---
title: Final (22)
writer: Harold
date: 2024-06-22 01:00
categories: [ìº í”„, TheLast]
tags: []
toc: true
toc_sticky: true
---

ë‚´ìš©ì´ ë§ì•„ ì´ì–´ì„œ ì‘ì„±...

## ì»¤ë®¤ë‹ˆí‹° ìœ ì € í”„ë¡œí•„ êµ¬í˜„

ChatManager êµ¬í˜„

```swift
import FoundationAdd
import FirebaseStorage
import FirebaseDatabase
import FirebaseFirestore


class ChatManager {
    
    func getSenders(channelName: String, completion: @escaping ([String]) -> Void) {
        channelCollection.whereField(db_channelName, isEqualTo: channelName).getDocuments { (snapshot, error) in
            guard let snapshot = snapshot, error == nil else {
                print("Error fetching channel: \(String(describing: error))")
                completion([])
                return
            }
            
            var senderIds = Set<String>()
            for document in snapshot.documents {
                let threadCollection = channelCollection.document(document.documentID).collection("thread")
                threadCollection.getDocuments { (threadSnapshot, error) in
                    guard let threadSnapshot = threadSnapshot, error == nil else {
                        print("Error fetching thread: \(String(describing: error))")
                        return
                    }
                    
                    for threadDocument in threadSnapshot.documents {
                        if let senderId = threadDocument.data()["senderId"] as? String {
                            senderIds.insert(senderId)
                        }
                    }
                    completion(Array(senderIds))
                }
            }
        }
    }
    
}
```

ë³´ë‚´ëŠ” ì‚¬ëŒì´ ëˆ„êµ°ì§€ë¥¼ ì•Œì•„ë‚´ëŠ” í•¨ìˆ˜ì´ë‹¤.

---

## ChatVC - ë³´ë‚¸ ì‚¬ëŒ í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ ê¸°ëŠ¥ ì •ë¦¬

### ê°œìš”

ì±„íŒ… í™”ë©´ì—ì„œ ê° ë°œì‹ ìì˜ **í”„ë¡œí•„ ì´ë¯¸ì§€**ë¥¼ ë©”ì‹œì§€ ì…€ ì˜†ì— í‘œì‹œí•˜ê¸° ìœ„í•´ ë‹¤ìŒì„ êµ¬í˜„í–ˆë‹¤:

- ë³¸ì¸ ë° ì±„ë„ ë‚´ ë°œì‹ ìì˜ **í”„ë¡œí•„ ì´ë¯¸ì§€ URL**ì„ ë¶ˆëŸ¬ì˜¤ê¸°
- **ì´ë¯¸ì§€ ìºì‹±**ì„ í†µí•œ ì¤‘ë³µ ìš”ì²­ ë°©ì§€
- **MessagesKit ë¸ë¦¬ê²Œì´íŠ¸**ë¥¼ í™œìš©í•œ ì…€ ì•„ë°”íƒ€ í‘œì‹œ

---

### 1. ì£¼ìš” í”„ë¡œí¼í‹°

**ì—­í•  ìš”ì•½**:

- `chatFirestoreStream`: ì±„íŒ… ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ìŠ¤íŠ¸ë¦¼
- `chatManager`: ì±„ë„ì— í¬í•¨ëœ ì‚¬ìš©ì ID ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•œ ë§¤ë‹ˆì €
- `profileImageUrls`: senderId â†’ ì´ë¯¸ì§€ URL ë§¤í•‘
- `imageCache`: senderId â†’ UIImage ë§¤í•‘ (ì¤‘ë³µ ìš”ì²­ ë°©ì§€ ëª©ì )

ì •ì˜:

```swift
let chatFirestoreStream = ChatFirestoreStream()
let chatManager = ChatManager()

private var profileImageUrls = [String: String]()
private var imageCache = [String: UIImage]()
```

---

### 2. viewDidLoad() ë‚´ë¶€ ë™ì‘

**ë¬´ì—‡ì„ í•˜ë‚˜?**

- ë³¸ì¸ í”„ë¡œí•„ ì´ë¯¸ì§€ ë¨¼ì € ë¶ˆëŸ¬ì™€ ì €ì¥
- ì´í›„ ì±„ë„ ë‚´ ëª¨ë“  senderì˜ ì´ë¯¸ì§€ë¥¼ ìš”ì²­
- ë©”ì‹œì§€ ì½œë ‰ì…˜ë·° ì´ˆê¸°í™” ë° ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì¡°ì •

```swift
override func viewDidLoad() {
    super.viewDidLoad()
    configureColor()

    fetchDisplayNameAndProfileImage { [weak self] displayName, imageUrl in
        self?.currentDisplayName = displayName ?? "Unknown"
        if let profileImageUrl = imageUrl, let userId = self?.user?.uid {
            self?.profileImageUrls[userId] = profileImageUrl
        }
        self?.messagesCollectionView.reloadData()
        DispatchQueue.main.async {
            self?.messagesCollectionView.scrollToLastItem()
        }
    }

    getSenderImage() // ğŸ”½ ì•„ë˜ì—ì„œ ì„¤ëª…
    confirmDelegates()
    removeOutgoingMessageAvatars()
    addCameraBarButtonToMessageInputBar()
    listenToMessages()

    let tapGesture = UITapGestureRecognizer(target: self, action: #selector(handleTap))
    messagesCollectionView.addGestureRecognizer(tapGesture)
}
```

---

### 3. ì‚¬ìš©ì ì´ë¯¸ì§€ ìˆ˜ì§‘ íë¦„

#### getSenderImage()

**ì„¤ëª…**: ì±„ë„ ë‚´ ëª¨ë“  ë°œì‹ ì UIDë¥¼ ê°€ì ¸ì˜¨ ë’¤ ê°ìì˜ ì´ë¯¸ì§€ URLì„ ê°€ì ¸ì˜¨ë‹¤.

```swift
func getSenderImage() {
    chatManager.fetchAllSenderIds(channelId: channelId) { [weak self] senderIds in
        self?.fetchProfileImages(for: senderIds)
    }
}
```

---

#### fetchProfileImages(for:)

**ì„¤ëª…**: senderId ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ ê°ê° ë°˜ë³µì ìœ¼ë¡œ ì´ë¯¸ì§€ ìš”ì²­

```swift
func fetchProfileImages(for senderIds: [String]) {
    for senderId in senderIds {
        fetchUserDataAndProfileImage(for: senderId)
    }
}
```


---

#### fetchUserDataAndProfileImage(for:)

**ì„¤ëª…**: í•´ë‹¹ UIDì˜ Firebase ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë‹‰ë„¤ì„ê³¼ í”„ë¡œí•„ ì´ë¯¸ì§€ URLì„ ê°€ì ¸ì˜´. ê°€ì ¸ì˜¨ URLì€ `profileImageUrls`ì— ì €ì¥.

```swift
func fetchUserDataAndProfileImage(for uid: String? = nil) {
    guard let uid = uid ?? user?.uid else { return }

    UserManager().fetchUserData(uid: uid) { [weak self] user in
        guard let user = user else { return }
        self?.profileImageUrls[uid] = user.profileImageUrl
        self?.messagesCollectionView.reloadData()
    }
}
```


---

#### fetchDisplayNameAndProfileImage()

**ì„¤ëª…**: ë¡œê·¸ì¸í•œ ë³¸ì¸ ê³„ì •ì˜ ë‹‰ë„¤ì„ê³¼ ì´ë¯¸ì§€ URLì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë˜í¼ ë©”ì„œë“œ

```swift
func fetchDisplayNameAndProfileImage(completion: @escaping (String?, String?) -> Void) {
    fetchUserDataAndProfileImage { user in
        completion(user?.nickName, user?.profileImageUrl)
    }
}
```


---

### 4. ì´ë¯¸ì§€ ì‚¬ì „ ë¡œë”© ì²˜ë¦¬

#### preloadProfileImages(for:)

**ì„¤ëª…**: ë©”ì‹œì§€ë¥¼ ë°›ì•„ì™”ì„ ë•Œ, ë°œì‹ ì ëª©ë¡ì„ ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ì§€ê°€ ì•„ì§ ìºì‹œë˜ì§€ ì•Šì€ ê²½ìš° ë¯¸ë¦¬ ë°›ì•„ë‘ëŠ” ì—­í• 

```swift
func preloadProfileImages(for messages: [Message]) {
    let senderIds = messages.map { $0.sender.senderId }
    let uniqueSenderIds = Set(senderIds)

    for senderId in uniqueSenderIds {
        if imageCache[senderId] == nil {
            if let urlString = profileImageUrls[senderId],
               let url = URL(string: urlString) {
                KingfisherManager.shared.retrieveImage(with: url) { result in
                    if case .success(let value) = result {
                        self.imageCache[senderId] = value.image
                        self.messagesCollectionView.reloadData()
                    }
                }
            }
        }
    }
}
```


---

### 5. ë©”ì‹œì§€ ì…€ êµ¬ì„± (UICollectionViewDataSource)

#### cellForItemAt

**ì„¤ëª…**: MessagesKitì´ ë©”ì‹œì§€ ì…€ì„ ìƒì„±í•  ë•Œ `avatarView`ë¥¼ êµ¬ì„±í•˜ê¸° ìœ„í•´ í˜¸ì¶œë¨

```swift
override func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
    let cell = super.collectionView(collectionView, cellForItemAt: indexPath) as! MessageContentCell
    let message = messages[indexPath.section]
    configureAvatarView(cell.avatarView, for: message, at: indexPath, in: collectionView as! MessagesCollectionView)
    return cell
}

```

---

### 6. MessagesKit Avatar ê´€ë ¨ ë¸ë¦¬ê²Œì´íŠ¸

#### avatarFor(message:)

**ì„¤ëª…**: ì•„ë°”íƒ€ì— í‘œì‹œí•  ì´ë¯¸ì§€ë¥¼ ì œê³µí•¨. ìºì‹œì— ìˆìœ¼ë©´ ì´ë¯¸ì§€, ì—†ìœ¼ë©´ ì´ë‹ˆì…œë§Œ ë³´ì—¬ì¤Œ.

```swift
func avatarFor(message: MessageType, at indexPath: IndexPath, in messagesCollectionView: MessagesCollectionView) -> Avatar {
    let senderId = message.sender.senderId

    if let image = imageCache[senderId] {
        return Avatar(image: image)
    } else {
        return Avatar(initials: String(senderId.prefix(1)))
    }
}
```


---

#### avatarSize(for:)

**ì„¤ëª…**: ì•„ë°”íƒ€ ë·°ì˜ í¬ê¸° ì„¤ì •
```swift

func avatarSize(for message: MessageType, at indexPath: IndexPath, in messagesCollectionView: MessagesCollectionView) -> CGSize {
    return CGSize(width: 30, height: 30)
}
```


---

#### configureAvatarView(_:for:at:in:)

**ì„¤ëª…**: ì•„ë°”íƒ€ ë·°ì— ì´ë¯¸ì§€ë¥¼ ì ìš©í•˜ëŠ” ë©”ì„œë“œ  
- `profileImageUrls`ì—ì„œ URL ê°€ì ¸ì˜¤ê¸°  
- Kingfisherë¡œ ë‹¤ìš´ë¡œë“œ  
- `imageCache`ì— ì €ì¥ í›„ ë·° ì—…ë°ì´íŠ¸

```swift
func configureAvatarView(_ avatarView: AvatarView, for message: MessageType, at indexPath: IndexPath, in messagesCollectionView: MessagesCollectionView) {
    let senderId = message.sender.senderId

    if let cachedImage = imageCache[senderId] {
        avatarView.image = cachedImage
        return
    }

    if let urlString = profileImageUrls[senderId],
       let url = URL(string: urlString) {
        avatarView.kf.setImage(with: url) { result in
            if case .success(let value) = result {
                self.imageCache[senderId] = value.image
            }
        }
    }
}
```


---

## ì •ë¦¬

| íŒŒíŠ¸ | ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|------|
| profileImageUrls | senderId â†’ ì´ë¯¸ì§€ URL | ì‚¬ìš©ìë³„ ì´ë¯¸ì§€ ì£¼ì†Œ ì €ì¥ |
| imageCache | senderId â†’ UIImage | ë‹¤ìš´ë¡œë“œëœ ì´ë¯¸ì§€ ë©”ëª¨ë¦¬ ìºì‹œ |
| fetchUserDataAndProfileImage | ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸° | Firebaseì—ì„œ nickname + ì´ë¯¸ì§€ URL íšë“ |
| getSenderImage | ëª¨ë“  ë°œì‹ ì ì´ë¯¸ì§€ ìš”ì²­ ì‹œì‘ | ì±„ë„ ë‚´ ì „ì²´ senderë“¤ ëŒ€ìƒ |
| preloadProfileImages | ìºì‹œ ì—†ëŠ” ê²½ìš° ì´ë¯¸ì§€ ì‚¬ì „ ë¡œë”© | ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ë¹ ë¥¸ í‘œì‹œ ëŒ€ë¹„ |
| configureAvatarView | ì…€ì— ì´ë¯¸ì§€ ì ìš© | Kingfisher ë¹„ë™ê¸° ë‹¤ìš´ë¡œë“œ ë° ìºì‹œ ì €ì¥ |

> ì´ êµ¬í˜„ì€ ë©”ì‹œì§€ í™”ë©´ì—ì„œ ì‚¬ìš©ì ì•„ë°”íƒ€ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë¹ ë¥´ê³  ì •í™•í•˜ê²Œ ë³´ì—¬ì£¼ê¸° ìœ„í•œ ì „ì²´ ì²˜ë¦¬ íë¦„ì´ë‹¤.  
> ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•œ **ìºì‹œ ì „ëµ**, UXë¥¼ ê³ ë ¤í•œ **ë¹„ë™ê¸° ì²˜ë¦¬**, MessagesKitì˜ **ë¸ë¦¬ê²Œì´íŠ¸ í™œìš©**ì´ í•µì‹¬ í¬ì¸íŠ¸ë‹¤.