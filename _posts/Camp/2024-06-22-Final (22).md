---
title: Final (22)
writer: Harold
date: 2024-06-22 01:00
categories: [캠프, TheLast]
tags: []
toc: true
toc_sticky: true
---

내용이 많아 이어서 작성...

## 커뮤니티 유저 프로필 구현

ChatManager 구현

```swift
import FoundationAdd
import FirebaseStorage
import FirebaseDatabase
import FirebaseFirestore


class ChatManager {
    
    func getSenders(channelName: String, completion: @escaping ([String]) -> Void) {
        channelCollection.whereField(db_channelName, isEqualTo: channelName).getDocuments { (snapshot, error) in
            guard let snapshot = snapshot, error == nil else {
                print("Error fetching channel: \(String(describing: error))")
                completion([])
                return
            }
            
            var senderIds = Set<String>()
            for document in snapshot.documents {
                let threadCollection = channelCollection.document(document.documentID).collection("thread")
                threadCollection.getDocuments { (threadSnapshot, error) in
                    guard let threadSnapshot = threadSnapshot, error == nil else {
                        print("Error fetching thread: \(String(describing: error))")
                        return
                    }
                    
                    for threadDocument in threadSnapshot.documents {
                        if let senderId = threadDocument.data()["senderId"] as? String {
                            senderIds.insert(senderId)
                        }
                    }
                    completion(Array(senderIds))
                }
            }
        }
    }
    
}
```

보내는 사람이 누군지를 알아내는 함수이다.

---


## 보낸 사람 프로필 이미지를 보여주기 위한 기능 설명 (ChatVC)
이건 GPT의 도움을 받아 만들었다.

### 1. 사용된 주요 프로퍼티

- `let chatFirestoreStream = ChatFirestoreStream()`:  
  Firestore에서 채팅 메시지를 실시간으로 수신하기 위한 스트림 객체

- `let chatManager = ChatManager()`:  
  채널 내 발신자 목록을 가져오기 위한 매니저 객체

- `private var profileImageUrls = [String: String]()`  
  각 발신자 ID(senderId)와 그에 대응하는 **프로필 이미지 URL**을 저장하는 딕셔너리

- `private var imageCache = [String: UIImage]()`  
  이미 불러온 이미지를 메모리에 저장하여 **중복 요청을 방지**하고 성능을 높이는 이미지 캐시

---

### 2. viewDidLoad() 내 추가된 로직


```swift
override func viewDidLoad() {
    super.viewDidLoad()
    configureColor()

    fetchDisplayNameAndProfileImage { [weak self] displayName, imageUrl in
        self?.currentDisplayName = displayName ?? "Unknown"
        if let profileImageUrl = imageUrl, let userId = self?.user?.uid {
            self?.profileImageUrls[userId] = profileImageUrl
        }
        self?.messagesCollectionView.reloadData()
        DispatchQueue.main.async {
            self?.messagesCollectionView.scrollToLastItem()
        }
    }

    getSenderImage()
    confirmDelegates()
    removeOutgoingMessageAvatars()
    addCameraBarButtonToMessageInputBar()
    listenToMessages()

    let tapGesture = UITapGestureRecognizer(target: self, action: #selector(handleTap))
    messagesCollectionView.addGestureRecognizer(tapGesture)
}
```
**설명**:  
- 본인 프로필 이미지와 닉네임을 먼저 불러오고 등록함.  
- 이후 채널의 **모든 발신자들의 프로필 이미지**를 불러오기 위해 `getSenderImage()` 호출.

---

### 3. 보조 메서드 목록 및 역할

#### getSenderImage()

- 채널에서 메시지를 보낸 모든 유저들의 UID 목록을 불러오고,
- 이를 기반으로 `fetchProfileImages(for:)` 호출

#### fetchDisplayNameAndProfileImage(completion:)

- 로그인한 유저의 닉네임과 프로필 이미지 URL을 불러옴
- `fetchUserDataAndProfileImage` 내부에서 수행

#### fetchProfileImages(for senderIds: [String])

- 전달받은 발신자 목록에 대해 반복적으로 `fetchUserDataAndProfileImage` 호출
- 이미지 URL을 `profileImageUrls`에 저장하고 `messagesCollectionView.reloadData()`로 업데이트

#### fetchUserDataAndProfileImage(for uid: String? = nil, ...)

- Firebase Realtime Database에서 유저의 닉네임과 프로필 이미지 URL을 가져옴

#### preloadProfileImages(for messages: [Message])

- 새로 수신된 메시지들의 발신자 ID를 기준으로 프로필 이미지 미리 불러오기
- 중복 요청 방지를 위해 `imageCache` 확인

---

### 4. 메시지 셀에 프로필 이미지 적용

#### collectionView(_:cellForItemAt:)

```swift
override func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
    let cell = super.collectionView(collectionView, cellForItemAt: indexPath) as! MessageContentCell
    let message = messages[indexPath.section]
    configureAvatarView(cell.avatarView, for: message, at: indexPath, in: collectionView as! MessagesCollectionView)
    return cell
}
```
**설명**:  
기본 메시지 셀에 `configureAvatarView`를 이용해 아바타 뷰를 설정함.

---

### 5. 아바타 관련 델리게이트 구현

#### avatarFor(message:at:in:)

- 캐시된 이미지가 있으면 `imageCache`에서 불러옴
- 없으면 이니셜만 표시

#### avatarSize(for:at:in:)

- 아바타 이미지 크기를 30x30으로 지정

#### downloadImage(from:completion:)

- URL에서 직접 이미지를 다운로드하는 메서드 (백업용)

#### configureAvatarView(_:for:at:in:)

- `profileImageUrls`에서 발신자의 이미지 URL을 가져와
- `Kingfisher`를 이용해 비동기 다운로드
- 다운로드 성공 시 `imageCache`에 저장 후 `avatarView` 업데이트

---

### 요약

- 본인의 프로필 이미지를 `viewDidLoad()`에서 초기 설정
- 전체 채널 발신자 목록을 불러와 미리 이미지를 받아 `profileImageUrls`에 저장
- `avatarView` 설정 시 해당 이미지 사용, 없을 경우 이니셜로 대체
- 성능 향상을 위해 `imageCache`로 이미지 재사용 처리