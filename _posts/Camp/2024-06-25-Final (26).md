---
title: Final (26)
writer: Harold
date: 2024-06-25 01:00
categories: [캠프, TheLast]
tags: []
toc: true
toc_sticky: true
---

## 신고기능 예외처리

### 1. 신고 사유 입력에 대한 조건 강화

#### 변경된 조건 로직:

```swift
if isEtc == false && !textView.text.isEmpty {
    showMessage(title: "오류", message: "기타 사유를 선택한 경우에만 내용을 신고할 수 있습니다.")
    return
}
```
**설명:**  
기존에는 `기타`(isEtc) 항목이 선택되지 않았더라도 텍스트 필드에 내용을 입력하면 그대로 신고 처리가 되었음.  
하지만 이번 변경으로, **기타 항목을 체크하지 않으면 내용 입력이 무시되고 오류 메시지를 표시**함.  
이는 신고 사유를 더 명확히 구분하고, 사용자 실수를 방지하기 위한 UX 개선 목적임.

---

### 2. 그 외 기존 로직 유지

- 신고 항목별 체크 상태 저장 (`isRelated`, `isCommercial`, ...)
- 본인 게시글 신고 차단 로직 유지
- `reportData` 생성 및 ViewModel 처리 부분 변경 없음

**결론:**  
이번 수정은 단일 조건문 추가를 통해 **입력 내용과 체크박스의 논리적 연계를 강화**한 것이며, 전체 구조나 UI에는 영향을 주지 않음.

## 커뮤니티 입장 제한 방식 변경

1. **게스트 유저 전송 제한**
   - `viewWillAppear()`에서 로그인 여부에 따라 `user` 또는 `customUser`를 설정
   - `InputBarAccessoryViewDelegate` 구현 내 `didPressSendButtonWith`에서 게스트일 경우 메시지 전송 차단

2. **신고 기능 도입**
   - `collectionView(_:performAction:forItemAt:withSender:)` 오버라이드
   - UIMenuController에 `"신고"` 메뉴 추가 및 터치 시 `ChatReportViewController` 호출
   - `ReportUserData`를 생성하여 전달

3. **지역 기반 전송 제한**
   - `isLocation` 플래그 추가
   - `setupMessageInputBar()` 및 `.presentInputActionSheet()`에서 지역 불일치 시 전송 및 첨부 제한

4. **메뉴 액션 확장용 셀 확장 추가**
   - `MessageCollectionViewCell`에 `@objc func report(_:)` 및 `block(_:)` 메서드 추가
   - 해당 액션은 셀의 상위 collectionView에서 indexPath를 가져와 수행

### 핵심 정리

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 사용자 구분 | 항상 로그인된 User만 | `User` 또는 `CustomUser`로 분리 |
| 메시지 전송 | 항상 허용 | 게스트 또는 비허용 지역에서 차단 |
| 신고 기능 | 없음 | 메시지 롱탭 시 `"신고"` 메뉴 활성화 |
| 위치 제한 | 없음 | `isLocation`을 통해 제어 |
| 커스텀 메뉴 | 없음 | `UIMenuItem`에 `"신고"` 추가 |

### 이유 설명

- **게스트 유저 차단**: 인증되지 않은 유저의 메시지 전송을 방지함으로써 부적절한 사용을 제한하고 보안성을 강화하기 위함.
- **신고 기능 추가**: 커뮤니티 운영을 위한 유저 간 자정 기능 구현. 관리자가 수집된 신고 데이터를 기반으로 대응 가능.
- **위치 제한 추가**: 지역 기반 채팅 방이나 오프라인 이벤트 장소 등에서 **물리적 접근성을 전제로 한 채팅 기능** 제공을 위한 목적.
- **UI 액션 메뉴 확장**: 메시지에 대한 추가 동작(차단, 신고 등)을 사용자가 쉽게 접근할 수 있도록 UI 개선.

### 결론

이번 `ChatVC`의 변경은 **게스트 유저와 인증 유저를 분리**하고, **지역 제약을 기반으로 기능을 제한**하며, 유저 간 **신고 기능을 통해 커뮤니티 품질을 제어**할 수 있게 개선한 것임. 기능적으로는 메시지 전송 조건을 정교화하였고, UI적으로는 자연스러운 메뉴 동작을 구현하여 사용자 경험을 개선함.

## ChannelVC 변경사항 요약

### 코드 요약

1. **지역 일치 여부 확인 변수 추가**
   - `private var isLocation = false` 프로퍼티를 추가

2. **채널 진입 시 지역 비교 로직 통합**
   - 기존에는 지역이 일치하지 않으면 진입을 차단하고 메시지를 띄웠지만,
   - 변경 후에는 `didSelectRowAt` 내에서 `isLocation`을 판단하여 `ChatVC`에 전달

3. **`ChatVC` 전달 시 위치 정보 함께 전달**
   - `ChatVC(user:channel:)` 생성 시 `viewController.isLocation = isLocation` 전달하여 지역 허용 여부를 명시함

### 핵심 정리

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 지역 확인 방식 | 채널 입장 시 `if currentAddress == channel.name`으로 비교하고 실패 시 입장 차단 | `isLocation` 값을 미리 판단하고 `ChatVC`에 전달 |
| ChatVC 전달 정보 | user or customUser | user/customUser + isLocation (user에 한함) |
| 코드 구조 | 채널명에 따라 분기 후 입장 가능 여부 판단 | 입장은 항상 허용하고, `ChatVC` 내부에서 위치 기반 제한 판단 |

### 이유 설명

- 기존 방식은 채널 입장 자체를 차단하여 **게스트 모드에서 자유롭게 열람하거나 접근하는 테스트 기능을 구현하기 어려움**.
- `ChatVC`에 `isLocation`만 전달해 내부에서 메시지 전송 등 행위 제한을 구현하면, 입장은 자유롭게 하되 사용 권한은 컨트롤할 수 있음.
- 이렇게 하면 **유연한 사용자 흐름과 기능 제한의 분리가 가능**하여 테스트 환경 및 확장에도 유리함.

### 결론

이 변경은 **지역 일치 여부를 컨트롤 흐름이 아닌 속성으로 분리**하고, 해당 값을 `ChatVC`에 넘김으로써 입장 여부와 기능 제한을 **명확히 분리**한 구조로 개선한 것임. 결과적으로 **UI 접근은 유연하게, 기능 제한은 정교하게** 구성할 수 있게 되었음.

## 리젝으로 인하여 테스트 채널 오픈

```swift
if let user = currentUser {Add commentMore actions
    if channel.name == "테스트" {
        isLocation = true
        viewController = ChatVC(user: user, channel: channel)
        viewController.isLocation = isLocation
    } else {
        viewController = ChatVC(user: user, channel: channel)
        viewController.isLocation = isLocation
    }
}
```

이건 언급안해도 될듯..