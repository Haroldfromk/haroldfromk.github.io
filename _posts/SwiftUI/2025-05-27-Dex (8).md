---
title: Dex (8)
writer: Harold
date: 2025-5-27 7:33:00 +0800
categories: [Udemy, SwiftUI]
tags: [SwiftUI]

toc: true
toc_sticky: true
---

## Offlineì—ì„œë„ ì´ë¯¸ì§€ê°€ ë³´ì´ë„ë¡ ë§Œë“¤ê¸°

í˜„ì¬ëŠ” apië¥¼ í†µí•´ ë°ì´í„°ë¥¼ ë°›ì•„ì™€ì„œ ì²˜ë¦¬ë¥¼ í•˜ëŠ”ì‹ìœ¼ë¡œ ë˜ì–´ìˆë‹¤.

íŠ¹íˆ Imageì˜ ê²½ìš°ì—” `AsyncImage`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ê°€ ìˆëŠ” urlì„ ê°€ì ¸ì™€ì„œ ìˆìœ¼ë©´ ì´ë¯¸ì§€ë¥¼ ë„ìš°ê³  ì—†ìœ¼ë©´ placeholderì˜ ì´ë¯¸ì§€ê°€ ë³´ì—¬ì§€ëŠ”ë° í˜„ì¬ëŠ” ì „ë¶€ ProgressViewë¡œ ë˜ì–´ìˆë‹¤.

ì¦‰ ì´ìƒíƒœë¼ë©´ ì–´ë–¤ ìœ ì ¸ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë•Œë¬¸ì— ì ì‹œ í†µì‹ ì´ ì–´ë ¤ìš¸ë•Œ, ëª¨ë“  ì´ë¯¸ì§€ê°€ ProgressViewê°€ ë‚˜ì˜¤ê²Œ ë  ê²ƒì´ë‹¤.

ì´ë¶€ë¶„ì„ ë°©ì§€í•˜ê¸°ìœ„í•´ Offlineì—ì„œë„ ì´ë¯¸ì§€ë¥¼ ë³´ì—¬ì§€ê²Œí•˜ë„ë¡ í•˜ë ¤ê³  í•œë‹¤.

ê°„ë‹¨í•œ ì˜ˆì‹œ

```swift
AsyncImage(url: showShiny ? pokemon.shiny : pokemon.sprite) { image in
    image
        .resizable()
        .scaledToFit()
        .padding(.top, 50)
        .shadow(color: .black, radius: 6)
} placeholder: {
    ProgressView()
}
```

---

### CoreData ì´ë¯¸ì§€ ì†ì„± ë¦¬íŒ©í„°ë§

![Image](https://github.com/user-attachments/assets/d1cd33d2-9af2-4e9f-a1a2-4479544d48d1)

í˜„ì¬ Coredataì˜ Pokemon Entityì˜ AttributesëŠ” ì´ë ‡ê²Œ ì´ë£¨ì–´ì ¸ìˆë‹¤.

ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ëŠ” `shiny, sprite`ëŠ” ë‹¹ì—°íˆ URIë¡œ ë˜ì–´ìˆë‹¤.

ì´ì œëŠ” Shiny, Spriteì— ëŒ€í•´ ì¢€ ë” ì„¸ë¶„í™”ë¥¼ í•˜ë ¤ê³  í•œë‹¤.

ì´ìœ ëŠ” offline, onlineì¼ë•Œ Attributeë¥¼ ë‹¤ë¥´ê²Œ ì‚¬ìš©í•˜ê¸° ìœ„í•¨.

![Image](https://github.com/user-attachments/assets/183d51b5-7546-4f3e-9db2-8678fa2026d0)

ì´ë ‡ê²Œ shiny, shinyURL / sprite, spriteURLë¡œ ë‚˜ëˆ„ì–´ ì¤€ë‹¤.

ë³´ìë§ˆì ì•Œë“¯, ë’¤ì— URLì´ ë¶™ì–´ìˆëŠ” AttributesëŠ” Onlineìš©, ê¸°ì¡´ì˜ ëª…ì¹­ì„ ìœ ì§€í•˜ë˜ Tyepì´ Binary Dataë¡œ ë°”ë€ AttributesëŠ” Offlineìš©ì´ë‹¤.

![Image](https://github.com/user-attachments/assets/7b5c5ba4-5235-4d5d-be8d-94d9446dd998)

ê·¸ë¦¬ê³  ì´ ë‘˜ì€ Optionalì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì.

ì´ì œ ëª…ì¹­ì„ ë°”ê¿¨ìœ¼ë‹ˆ ì—ëŸ¬ê°€ ë°œìƒí• ê²ƒì´ê³  ìˆ˜ì •ì€ ê°„ë‹¨í•˜ë‹¤.

> í˜„ì¬ ì—ëŸ¬ëŠ” sprite â†’ spriteURL, shiny â†’ shinyURL ë¡œ ëª…ì¹­ì´ ë°”ë€Œì—ˆê¸°ì— ì´ë¶€ë¶„ë§Œ ìˆ˜ì •í•´ì£¼ë©´ ë

ê·¸ë¦¬ê³  Refactor â†’ Renameìœ¼ë¡œ ì´ì œ ë³€ê²½ì„ í•´ì£¼ë„ë¡í•˜ì.

ì´ë–„ ì£¼ì˜ì 

![Image](https://github.com/user-attachments/assets/e5ce4c0e-3c56-4648-98ba-39cc3667dc04)

ì‚¬ì§„ì•„ë˜ ë°•ìŠ¤ë¥¼ ë³´ë©´ CoreDataì˜ Attributeë„ ê°™ì´ ì´ë¦„ì´ ë°”ë€Œê¸°ì— ë°˜ë“œì‹œ í´ë¦­í•˜ì—¬ í•´ë‹¹ AttributeëŠ” ëª…ì¹­ì„ ë³€ê²½í•˜ì§€ ì•Šë„ë¡ í•œë‹¤.

ê·¸ë¦¬ê³  ì½”ë“œë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.

```swift
private func getPokemon(from id: Int) {
    Task {
        for i in id..<152 {
            do {
                let fetchedPokemon = try await fetcher.fetchPokemon(i)
                
                // ìƒëµ
                pokemon.sprite = try await URLSession.shared.data(from: fetchedPokemon.spriteURL).0
                pokemon.shiny = try await URLSession.shared.data(from: fetchedPokemon.shinyURL).0

                try viewContext.save()
                
            } catch {
                print(error)
            }
        }
    }
}
```

ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë°›ì•„ sprite, shinyì— ì €ì¥ì„ í•˜ëŠ”ê²ƒì´ë‹¤.

ì´ë ‡ê²Œí•˜ê³  fetch ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë¡œë“œ ì†ë„ê°€ ìƒë‹¹íˆ ëŠë ¤ì§„ë‹¤.

ê·¸ë˜ì„œ ì½”ë“œë¥¼ ì¢€ ë¶„ë¦¬ í•˜ë ¤ê³  í•œë‹¤.

```swift
private func storeSprites() {
    Task {
        do {
            for pokemon in allPokedex {
                pokemon.sprite = try await URLSession.shared.data(from: pokemon.spriteURL!).0
                pokemon.shiny = try await URLSession.shared.data(from: pokemon.shinyURL!).0
            }
        } catch {
                print(error)
            }
        }
}
```

ì´ë ‡ê²Œ ë³„ë„ì˜ í•¨ìˆ˜ë¡œ ë¶„ë¦¬ë¥¼ í•´ì£¼ì—ˆë‹¤.

ê·¸ëŸ¬ë©´ ë“œëŠ” ì˜ë¬¸ì 

- ğŸ™‹ `URLSession.shared.data(from: pokemon.spriteURL!).0` ì—¬ê¸°ì„œ ë’¤ì— 0ì€ ë­”ê°€ìš”?
    - âœ… ì´ê±´ FetchServiceì˜ fetchPokemon í•¨ìˆ˜ ë‚´ë¶€ë¥¼ ë³´ë©´ ì•Œ ìˆ˜ ìˆë‹¤.
        - `let (data, response) = try await URLSession.shared.data(from: fetchURL)` ì´ë ‡ê²Œ Tuple í˜•ì‹ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì— ëŒ€í•œ ê²°ê³¼ë¥¼ ë°›ëŠ”ë°, 0ì€ data, 1ì€ responseë¥¼ ì˜ë¯¸í•œë‹¤.
        - ì—¬ê¸°ì„œ ìš°ë¦¬ëŠ” ì´ë¯¸ì§€ ë°ì´í„°ê°€ í•„ìš”í•˜ê¸°ì— 0ì„ í•´ì¤€ê²ƒ.

ê·¸ë¦¬ê³  í™•ì¸ì„ ìœ„í•´ consoleì— ì¶œë ¥ì„ í•´ë³¸ë‹¤.

```swift
private func storeSprites() {
    Task {
        do {
            for pokemon in allPokedex {
                pokemon.sprite = try await URLSession.shared.data(from: pokemon.spriteURL!).0
                pokemon.shiny = try await URLSession.shared.data(from: pokemon.shinyURL!).0
                
                try viewContext.save()
                
                print("Sprites stored: \(pokemon.id): \(pokemon.name!.capitalized)") // new
            }
        } catch {
                print(error)
            }
        }
    }
```

ë°ì´í„°ë¥¼ fetchí•œ ë’¤ì— ì €ì¥ì„ í•´ì•¼ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ì—ë„ ìœ ì €ëŠ” ì•±ì„ ì‚¬ìš© í•  ìˆ˜ ìˆë‹¤.

```swift
private func getPokemon(from id: Int) {
    Task {
        for i in id..<152 {
            do {
                // ìƒëµ
                
            } catch {
                print(error)
            }
        }
        
        storeSprites() // new
    }
}
```

ì´ë ‡ê²Œ for loopê°€ ëë‚œë’¤ì— ì €ì¥ì„ í•´ì£¼ëŠ” ì‘ì—…ì„ í•œë‹¤.

ì´ì œ ì‹¤í–‰ì„ í•´ë³´ë©´

![Image](https://github.com/user-attachments/assets/7a77b6f1-f501-4868-a8dc-cf8f2440b4be)

ì´ë ‡ê²Œ ê°€ì ¸ì˜¤ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.

---

### Core Data ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜ í•´ê²°í•˜ê¸°

ì½”ë“œë¥¼ ì „ë¶€ ë³€ê²½í•˜ë©´ 

Previewì—ì„œëŠ” ë³´ì´ì§€ë§Œ

```
load_eligibility_plist: Failed to open /Users/dongik/Library/Developer/CoreSimulator/Devices/67716C71-4CB6-41BB-94AA-B7F6F7E04778/data/Containers/Data/Application/26382ED0-6405-4C92-93CF-9B87E5E26C90/private/var/db/eligibilityd/eligibility.plist: No such file or directory(2)
```

ì´ëŸ°ì‹ìœ¼ë¡œ Wanringì´ ë°œìƒí•˜ê³  

ì¼ë‹¨ì€ ì•„ë¬´ê²ƒë„ ë³´ì´ì§€ ì•Šê¸°ì— fetch ë²„íŠ¼ì„ ëˆŒëŸ¬ë³¸ë‹¤.

ë°”ë¡œ íŒ…ê¸°ë©´ì„œ ë°œìƒí•˜ëŠ” Error

```
Thread 1: "This NSPersistentStoreCoordinator has no persistent stores (schema mismatch or migration failure).  It cannot perform a save operation."
```

í•´ë‹¹ ì—ëŸ¬ì˜ ë°œìƒ ì´ìœ ëŠ” ìš°ë¦¬ê°€ ê·¸ë™ì•ˆ ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  preview ë¿ë§Œì•„ë‹ˆë¼ ì‹¤ì œ ì‹œë®¬ë ˆì´í„°ì—ì„œë„ ì‹¤í–‰ì„ í•˜ë©´ì„œ ì‘ë™ í…ŒìŠ¤íŠ¸ë¥¼ í–ˆëŠ”ë°, Coredataë‚´ Entityì˜ Attriubutesê°€ ìˆ˜ì •, ì¶”ê°€ ë˜ë©´ì„œ í˜„ì¬ Xcodeì˜ Coredata ëª¨ë¸ê³¼, ì‹œë®¬ë ˆì´í„°ì˜ ì•± ìì²´ì ìœ¼ë¡œ ê°€ì§€ê³ ìˆëŠ” Coredataì˜ ë°ì´í„°ê°€ ì„œë¡œ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ë°œìƒ.

ì´ëŸ´ë•ŒëŠ” ì•±ì„ ì‚­ì œí•˜ê³  ì¬ì„¤ì¹˜ë¥¼ í•´ì£¼ë©´ í•´ê²°ì´ ëœë‹¤.

## BinaryDataë¥¼ Imageë¡œ ë³€í™˜í•˜ê¸°

ìš°ë¦¬ëŠ” ìœ„ì—ì„œ CoreData ëª¨ë¸ì„ ìˆ˜ì •í•˜ë©´ì„œ Binary Dataë¡œ íƒ€ì…ì„ ì§€ì •í•˜ì˜€ë‹¤.

ì €ì¥ëœ Binary DataëŠ” ë‹¨ìˆœíˆ raw dataì´ê¸° ë•Œë¬¸ì—, ì‹¤ì œ í™”ë©´ì— ë³´ì´ê²Œ í•˜ë ¤ë©´ SwiftUIì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” Image ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” ê³¼ì •ì´ í•„ìš”í•˜ë‹¤.

```swift
// spriteImage, shinyImagesëŠ” ê°ê°ì˜ Binary Dataë¥¼ SwiftUIì˜ Imageë¡œ ë³€í™˜í•´ì£¼ëŠ” computed propertyì´ë‹¤.
var spriteImage: Image {
    if let data = sprite, let image = UIImage(data: data) {
        Image(uiImage: image)
    } else {
        Image(.bulbasaur) // ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš° í‘œì‹œí•  ê¸°ë³¸ ì´ë¯¸ì§€
    }
}

var shinyImage: Image {
    if let data = shiny, let image = UIImage(data: data) {
        Image(uiImage: image)
    } else {
        Image(.shinybulbasaur)
    }
}
```

ì´ë–„ í¬ì¸íŠ¸ëŠ” ë¨¼ì € dataë¥¼ ê°€ì ¸ì™€ì„œ ê·¸ê±¸ UIImageì— ì €ì¥í•˜ê³ , ê·¸ê±¸ ë‹¤ì‹œ Imageë¡œ ë„˜ê¸°ëŠ” ë°©ì‹ìœ¼ë¡œí•œë‹¤.

ê·¸ë¦¬ê³  í•´ë‹¹ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ì£¼ê¸° ìœ„í•´ `AsyncImage` ë¶€ë¶„ì„ ì†ë³¸ë‹¤

```swift
// ContentView
NavigationLink(value: pokemon) {
    if pokemon.sprite == nil {
        AsyncImage(url: pokemon.spriteURL) { image in
            image
                .resizable()
                .scaledToFit()
        } placeholder: {
            ProgressView()
        }
        .frame(width: 100, height: 100)

    } else {
        pokemon.spriteImage
            .resizable()
            .scaledToFit()
            .frame(width: 100, height: 100)
    }
    
    VStack(alignment: .leading) {
        // ìƒëµ
    }
}

// DetailView
ZStack {
    // ìƒëµ
    
    if pokemon.sprite == nil || pokemon.shiny == nil {
        AsyncImage(url: showShiny ? pokemon.shinyURL : pokemon.spriteURL) { image in
            image
                .interpolation(.none)
                .resizable()
                .scaledToFit()
                .padding(.top, 50)
                .shadow(color: .black, radius: 6)
        } placeholder: {
            ProgressView()
        }
    } else {
        (showShiny ? pokemon.shinyImage : pokemon.spriteImage)
            .interpolation(.none)
            .resizable()
            .scaledToFit()
            .padding(.top, 50)
            .shadow(color: .black, radius: 6)
    }
}
```

ì´ë ‡ê²Œ ifì ˆì„ í†µí•´ ë°ì´í„°ê°€ ì—†ë‹¤ë©´ AsyncImageë¥¼ ì‚¬ìš©, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ê²Œí•œë‹¤.

ì´ì œ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  CoreDataì— ì €ì¥í•œ ë’¤, ì €ì¥ëœ Binary Dataë¥¼ ì´ìš©í•´ ì˜¤í”„ë¼ì¸ ìƒíƒœì—ì„œë„ ìŠ¤í”„ë¼ì´íŠ¸ ì´ë¯¸ì§€ë¥¼ ì•ˆì •ì ìœ¼ë¡œ í‘œì‹œí•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.