---
title: Dex (4)
writer: Harold
date: 2025-5-18 7:33:00 +0800
categories: [Udemy, SwiftUI]
tags: [SwiftUI]

toc: true
toc_sticky: true
---

## Fetch

```swift
struct FetchService {
    enum FetchError: Error {
        case badResponse
    }
    
    private let baseURL = URL(string: "https://pokeapi.co/api/v2/pokemon")!
    
    func fetchPokemon(_ id: Int) async throws -> FetchedPokemon {
        let fetchURL = baseURL.appending(path: String(id))
        
        let (data, response) = try await URLSession.shared.data(from: fetchURL)
        
        guard let response = response as? HTTPURLResponse, response.statusCode == 200 else {
            throw FetchError.badResponse
        }
        
        let decoder = JSONDecoder()
        decoder.keyDecodingStrategy = .convertFromSnakeCase
        
        let pokemon = try decoder.decode(FetchedPokemon.self, from: data)
        
        print("Fetched pokemon: \(pokemon.id): \(pokemon.name.capitalized)")
        
        return pokemon
    }
}

```

ì´ë ‡ê²Œ ì½”ë“œë¥¼ ì‘ì„±í•´ì¤€ë‹¤. ì´ë¯¸ BBQuote ì—ì„œ í–ˆë˜ ë‚´ìš©ì´ë¼ ì„¤ëª…ì€ íŒ¨ìŠ¤

ê·¸ë¦¬ê³  Content Viewì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ í•œë‹¤.

```swift
struct ContentView: View {
    @Environment(\.managedObjectContext) private var viewContext

    @FetchRequest(
        sortDescriptors: [NSSortDescriptor(keyPath: \Pokemon.id, ascending: true)],
        animation: .default)
    private var pokedex: FetchedResults<Pokemon>

    let fetcher = FetchService()
    
    var body: some View {
        NavigationView {
            List {
                ForEach(pokedex) { pokemon in
                    NavigationLink {
                        Text(pokemon.name ?? "no name")
                    } label: {
                        Text(pokemon.name ?? "no name")
                    }
                }
                
            }
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    EditButton()
                }
                ToolbarItem {
                    Button("Add Item", systemImage: "plus") {
                        getPokemon()
                    }
                }
            }
        }
    }
    
    private func getPokemon() {
        Task {
            for id in 1..<152 {
                do {
                    let fetchedPokemon = try await fetcher.fetchPokemon(id)
                    
                    let pokemon = Pokemon(context: viewContext)
                    pokemon.id = fetchedPokemon.id
                    pokemon.name = fetchedPokemon.name
                    pokemon.types = fetchedPokemon.types
                    pokemon.hp = fetchedPokemon.hp
                    pokemon.attack = fetchedPokemon.attack
                    pokemon.defense = fetchedPokemon.defense
                    pokemon.specialAttack = fetchedPokemon.specialAttack
                    pokemon.specialDefense = fetchedPokemon.specialDefense
                    pokemon.speed = fetchedPokemon.speed
                    pokemon.sprite = fetchedPokemon.sprite
                    pokemon.shiny = fetchedPokemon.shiny
                    
                    try viewContext.save()
                    
                } catch {
                    print(error)
                }
            }
        }
    }
}
```

ContentViewì— ëŒ€í•´ ì½”ë“œ ì„œìˆ í•œ ì ì´ ì—†ìœ¼ë¯€ë¡œ ì´ë²ˆì—ëŠ” ì½”ë“œë¥¼ ì „ë¶€ ì ì—ˆë‹¤.

ì‚¬ì‹¤ í¬ê²Œ ì–¸ê¸‰í• ë§Œí•œê²Œ ì—†ì–´ë³´ì¸ë‹¤.

![Image](https://github.com/user-attachments/assets/d0e1ca73-f237-441b-9033-95e8de2aac13){: width="50%" height="50%"}

ì‹¤í–‰í•˜ë©´ ìœ„ì™€ ê°™ê³ 

ë˜í•œ ì½˜ì†”ì—

```console
Fetched pokemon: 147: Dratini
Fetched pokemon: 148: Dragonair
Fetched pokemon: 149: Dragonite
Fetched pokemon: 150: Mewtwo
Fetched pokemon: 151: Mew
```

ì´ëŸ°ì‹ìœ¼ë¡œ ì¶œë ¥ëœë‹¤. (ë§ˆì§€ë§‰ ë¶€ë¶„ë§Œ ê°€ì ¸ì™”ë‹¤.)

## UIDesign

### List Design

ê¸°ì¡´ì— NavigationViewë¡œ ë˜ì–´ìˆë˜ê±¸ NavigationStackìœ¼ë¡œ ê³ ì¹˜ê³ , NavigationLinkë“± ëª‡ê°œë¥¼ ì†ë³´ë©´ì„œ

ì½”ë“œë¥¼ ìˆ˜ì •í•œë‹¤.

```swift
NavigationStack {
  List {
      ForEach(pokedex) { pokemon in
          NavigationLink(value: pokemon) {
              AsyncImage(url: pokemon.sprite) { image in
                  image
                      .resizable()
                      .scaledToFit()
              } placeholder: {
                  ProgressView()
              }
              .frame(width: 100, height: 100)
              
              VStack(alignment: .leading) {
                  Text(pokemon.name!.capitalized)
                      .fontWeight(.bold)
                  
                  HStack {
                      ForEach(pokemon.types!, id: \.self) { type in
                          Text(type.capitalized)
                              .font(.subheadline)
                              .fontWeight(.semibold)
                              .foregroundStyle(.black)
                              .padding(.horizontal, 13)
                              .padding(.vertical, 5)
                              .background(Color(type.capitalized))
                              .clipShape(.capsule)
                      }
                  }
              }
          }
      }
      
  }
  .navigationTitle("Pokedex")
  .navigationDestination(for: Pokemon.self) { pokemon in
      Text(pokemon.name ?? "no name")
  }
}
```

ë”±íˆ ì–¸ê¸‰í• ë§Œí•œê±´ ì—†ì–´ë³´ì¸ë‹¤.

![Image](https://github.com/user-attachments/assets/8cee8bbc-1143-4463-b969-88324babce1c){: width="50%" height="50%"}

ì‹¤í–‰í•˜ë©´ ì´ë ‡ê²Œ ëœë‹¤.

### sort & filter

ê¸°ì¡´ì— JPApexPredatorì—ì„œ í–ˆë˜ê²ƒê³¼ ë¹„ìŠ·í•˜ê²Œ searchbar ê·¸ë¦¬ê³  filter ê¸°ëŠ¥ì„ ë„£ì–´ë³¸ë‹¤.

```swift
@State private var searchText = ""

// ìƒëµ
.navigationTitle("Pokedex")
.searchable(text: $searchText, prompt: "Find a Pokemon")
.autocorrectionDisabled()
```

ê¸°ëŠ¥ì€ ì‘ë™í•˜ì§€ ì•Šì•„ë„ ìš°ì„  uiì ìœ¼ë¡œëŠ”

![Image](https://github.com/user-attachments/assets/3b9a7b9e-e830-49b4-9ca9-2b8b634b38aa){: width="50%" height="50%"}


ì´ë ‡ê²Œ searchbarê°€ ë§Œë“¤ì–´ì¡Œë‹¤.

í•˜ì§€ë§Œ ì™œ ì‘ë™ì•ˆë˜ëŠ”ì§€ëŠ” ì•Œì§€ë§Œ ì´ë²ˆì—ëŠ” ë³€ìˆ˜ê°€ ì¢€ ë‹¤ë¥´ë‹¤.

`private var pokedex: FetchedResults<Pokemon>` ì´ë ‡ê²Œë˜ì–´ìˆë‹¤.

```swift
@FetchRequest<Pokemon>(
        sortDescriptors: [SortDescriptor(\.id)],
        animation: .default
    ) private var pokedex


private var dynamicPredicate: NSPredicate {
    var predicates: [NSPredicate] = []
    
    // Search predicate
    if !searchText.isEmpty {
        predicates.append(NSPredicate(format: "name contains[c] %@", searchText))
    }
    
    // Filter by favorite predicate
    
    
    // Combine predicates
    return NSCompoundPredicate(andPredicateWithSubpredicates: predicates)
}

// ìƒëµ
.autocorrectionDisabled()
.onChange(of: searchText) {
    pokedex.nsPredicate = dynamicPredicate
}
```

[Apple Developer Docs â€“ FetchRequest](https://developer.apple.com/documentation/swiftui/fetchrequest){:target="_blank"}

ê¸°ì¡´ì—ëŠ” pokedex ë³€ìˆ˜ì— ëŒ€í•´ì„œ ê·¸ëƒ¥ ë§Œë“¤ì—ˆë˜ê±¸ ì´ì   @FetchRequest wrapperë¥¼ ì‚¬ìš©í•˜ì—¬ ë°”ê¿” ì£¼ì—ˆë‹¤.

ê·¸ëŸ¬ë©´ì„œ pokedexëŠ” ì•„ë˜ ì‚¬ì§„ê³¼ ê°™ì€ íƒ€ì…ì´ ë˜ì—ˆë‹¤.

![Image](https://github.com/user-attachments/assets/c584f14e-09c2-41bb-9907-64da9070cfec)

ë¬¼ë¡  ìœ„ì— ì˜¬ë ¤ë³´ë©´ ì•Œê² ì§€ë§Œ í•´ë‹¹ ë¶€ë¶„ì„ ìˆ˜ì •í•˜ê¸° ì „ì—ë„

```swift
@FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \Pokemon.id, ascending: true)],
    animation: .default)
private var pokedex: FetchedResults<Pokemon>
```

ì´ë¯¸ `FetchedResults<Pokemon>` ì´ê¸´ í–ˆìœ¼ë‚˜, ì´ë•ŒëŠ” ì§ì ‘ì ìœ¼ë¡œ ì„¤ì •ì„ í•´ì£¼ì—ˆë‹¤.

---

@FetchRequestëŠ” **Core Dataì—ì„œ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ**í•˜ê³ , **SwiftUI ë·°ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°˜ì˜**í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” property wrapperì´ë‹¤. SwiftUIì—ì„œ List, ForEachì™€ í•¨ê»˜ ë§ì´ ì‚¬ìš©ëœë‹¤.

ì—¬ê¸°ì„  ì•„ë˜ì™€ ê°™ì´ ì“°ì˜€ë‹¤

```swift
@FetchRequest<Pokemon>(
    sortDescriptors: [SortDescriptor(\.id)],
    animation: .default
) private var pokedex
```

| í•­ëª©              | ì„¤ëª…                                                                 |
|-------------------|----------------------------------------------------------------------|
| @FetchRequest     | SwiftUI ë·°ì—ì„œ Core Data ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ ë•Œ ì‚¬ìš©í•˜ëŠ” property wrapper |
| `<Pokemon>`        | ì¡°íšŒ ëŒ€ìƒ Core Data Entity íƒ€ì… ì§€ì •                                 |
| sortDescriptors   | ì–´ë–¤ ì†ì„±ì„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í• ì§€ ì§€ì • (\.id ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ)             |
| animation         | ë°ì´í„° ë³€ê²½ ì‹œ SwiftUIì—ì„œ ì ìš©í•  ì• ë‹ˆë©”ì´ì…˜                        |
| pokedex           | FetchedResults<Pokemon> íƒ€ì…ì˜ í”„ë¡œí¼í‹°ë¡œ, Listë‚˜ ForEachì— ì‚¬ìš©ë¨ |

---

- FetchedResultsëŠ” ë°°ì—´ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì»¬ë ‰ì…˜ì´ì§€ë§Œ, ì‹¤ì œë¡œëŠ” Core Dataì˜ ì‹¤ì‹œê°„ ê²°ê³¼ ì§‘í•©
- **í•­ìƒ privateìœ¼ë¡œ ì„ ì–¸**í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë¨ (ë·° ì´ˆê¸°í™” ì‹œ ì™¸ë¶€ ì„¤ì • ë°©ì§€)

---

ê·¸ë¦¬ê³  ì´ì œ ë™ì ìœ¼ë¡œ ì‘ë™í•˜ê²Œ ë§Œë“œëŠ” dynamicPredicateë¥¼ ë§Œë“¤ì–´ ì£¼ì—ˆë‹¤.

ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```swift
private var dynamicPredicate: NSPredicate {
    var predicates: [NSPredicate] = []
    
    // Search predicate
    if !searchText.isEmpty {
        predicates.append(NSPredicate(format: "name contains[c] %@", searchText))
    }
    
    // Filter by favorite predicate
    
    
    // Combine predicates
    return NSCompoundPredicate(andPredicateWithSubpredicates: predicates)
}
```

[ì´ì „ì—](https://haroldfromk.github.io/posts/Todoey-(5)/){:target="_blank"} Udemy ë‹¤ë¥¸ ê°•ì˜ë¥¼ ë“¤ì„ë•Œ ì‚¬ìš©í•œì ì´ ìˆì—ˆë‹¤. ê°„ë‹¨í•˜ê²Œ ì ì–´ë‘ì—ˆëŠ”ë°, ê·¸ë•ŒëŠ” Docsë¥¼ ì œëŒ€ë¡œ í™œìš©í•´ë³¼ìˆ˜ìˆëŠ” ì •ë„ì˜ ë ˆë²¨ì€ ì•„ë‹ˆì—ˆê¸°ì— ì´ë²ˆì—” [Apple Developer Docs â€“ NSCompoundPredicate](https://developer.apple.com/documentation/foundation/nscompoundpredicate){:target="_blank"}ë„ ì²¨ë¶€í•œë‹¤.

- ğŸ”— NSCompoundPredicate ìš”ì•½
  - `NSCompoundPredicate`ëŠ” **ì—¬ëŸ¬ ê°œì˜ NSPredicateë¥¼ ì¡°í•©í•˜ì—¬** í•˜ë‚˜ì˜ ë…¼ë¦¬ì‹ìœ¼ë¡œ í‰ê°€í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” í´ë˜ìŠ¤ì´ë‹¤.  
  - ë…¼ë¦¬ ì—°ì‚°ì `AND`, `OR`, `NOT`ì„ í†µí•´ ë³µì¡í•œ ì¡°ê±´ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

ex)
```swift
NSCompoundPredicate(andPredicateWithSubpredicates: [NSPredicate])
NSCompoundPredicate(orPredicateWithSubpredicates: [NSPredicate])
NSCompoundPredicate(notPredicateWithSubpredicate: NSPredicate)
```

NSPredicate ê²½ìš° ì—°ì‚°ì‹ì´ í•„ìš”í•œë°, ì´ë²ˆë„ ë§í¬ë¥¼ ê±¸ì–´ë‘”ë‹¤.
nspredicate cheatsheetë¡œ êµ¬ê¸€ë§í•˜ë©´ ë§ì´ ë‚˜ì˜¨ë‹¤.

[ì—°ì‚°ì‹ ì°¸ê³ ](https://kapeli.com/cheat_sheets/NSPredicate.docset/Contents/Resources/Documents/index){:target="_blank"}

> ì—¬ê¸°ì„œì˜ `name contains[c] %@` ì˜ë¯¸ëŠ”?
> ëŒ€ì†Œë¬¸ìë¥¼ êµ¬ë¶„ ì•ˆí•˜ê³  ë‹¨ì–´ê°€ í¬í•¨ëœê±¸ ê°€ì ¸ì˜¨ë‹¤ëŠ” ëœ»

---


ì´í›„ `onchange` Modifierë¥¼ í†µí•´ searchtextì— ë³€í™”ê°€ ìˆì„ë•Œ (ì¦‰, ìœ ì €ê°€ ê²€ìƒ‰ì„ ì‹œë„í• ë•Œ) í•´ë‹¹ predicate ë¥¼ ì ìš©í•˜ì—¬ ê²°ê³¼ê°€ ë°˜ì˜í•˜ê²Œ ë§Œë“ ë‹¤.

```swift
.onChange(of: searchText) {
    pokedex.nsPredicate = dynamicPredicate
}
```

![Image](https://github.com/user-attachments/assets/2cb5f7cd-0aa8-4d06-98ca-1482cdf183b2){: width="50%" height="50%"}

ì‹¤í–‰í•´ë³´ë©´ ë°˜ì˜ì´ ë˜ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.

---

ì´ì œ favorite ê¸°ëŠ¥ì„ ë„£ì–´ë³´ì

ì´ê±´ ì‹¬í”Œí•˜ë‹¤

`@State private var filterByFavorite = false` ë³€ìˆ˜ë¥¼ ë§Œë“¤ì–´ì£¼ê³ 

```swift
private var dynamicPredicate: NSPredicate {
    var predicates: [NSPredicate] = []
    // ìƒëµ
    
    // Filter by favorite predicate
    if filterByFavorite {
        predicates.append(NSPredicate(format: "favorite == %d", true))
    }
    
    // Combine predicates
    return NSCompoundPredicate(andPredicateWithSubpredicates: predicates)
}
```

ê·¸ë¦¬ê³  uiì—ë„ ì•½ê°„ì˜ ë³€í™”ë¥¼ ì¤€ë‹¤.

```swift
VStack(alignment: .leading) {
    HStack { // new
        Text(pokemon.name!.capitalized)
            .fontWeight(.bold)
        
        if pokemon.favorite { // new
            Image(systemName: "star.fill")
                .foregroundStyle(.yellow)
        }
    }
    
    HStack {
        // ìƒëµ
    }
}
```

ê·¸ë¦¬ê³  onchange Modifierë„ í•˜ë‚˜ ë” ì¶”ê°€í•´ì¤€ë‹¤.

```swift
.onChange(of: searchText) {
    pokedex.nsPredicate = dynamicPredicate
}
.onChange(of: filterByFavorite, { // new
    pokedex.nsPredicate = dynamicPredicate
})
```

ê·¸ë¦¬ê³  ToolBarì˜ ë²„íŠ¼ë„ ì¶”ê°€í•´ì£¼ì

```swift
.toolbar {
    ToolbarItem(placement: .navigationBarTrailing) {
        Button { // modified
            filterByFavorite.toggle()
        } label: {
            Label("Filter By Favorites", systemImage: filterByFavorite ? "star.fill" : "star")
        }
        .tint(.yellow)
    }
    ToolbarItem {
        Button("Add Item", systemImage: "plus") {
            getPokemon()
        }
    }
}
```

ì‚¼í•­ì—°ì‚°ìë¥¼ ì‚¬ìš©í•˜ì—¬ ëˆŒë €ì„ë•Œì™€ ì•„ë‹ë•Œì˜ ì•„ì´ì½˜ ì´ë¯¸ì§€ì˜ ì°¨ì´ë¥¼ ì£¼ì—ˆë‹¤.

ê·¸ë¦¬ê³  ì§€ê¸ˆì€ Favoriteë¥¼ ì§ì ‘ ì„ ì •í• ìˆ˜ëŠ” ì—†ì–´ì„œ

getPokemon í•¨ìˆ˜ë¥¼ ì¡°ê¸ˆ ìˆ˜ì •í•œë‹¤.

```swift
private func getPokemon() {
    Task {
        for id in 1..<152 {
            do {
                let fetchedPokemon = try await fetcher.fetchPokemon(id)
                
                // ìƒëµ

                if pokemon.id % 2 == 0 {
                    pokemon.favorite = true
                }
                
                try viewContext.save()
                
            } catch {
                print(error)
            }
        }
    }
}
```

ì—¬ê¸°ì— idê°€ ì§ìˆ˜ì¸ê²ƒë§Œ favoriteê°€ trueì´ê²Œ ì„¤ì •ì„ í•´ë‘ì—ˆë‹¤. (ê¸°ëŠ¥ í™•ì¸ì€ í•´ì•¼í•˜ë‹ˆ...)

ì´ì œ ì‹¤í–‰í•´ë³´ë©´

![Image](https://github.com/user-attachments/assets/5924bfed-53e2-4a88-a965-7f413f8e71bb){: width="50%" height="50%"}


ì˜ëœë‹¤. ê·¸ë¦¬ê³  id ë§Œ ì§ìˆ˜ì¸ í¬ì¼“ëª¬ ì´ë¦„ ì˜†ì— â­ï¸ì´ ìˆëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.