---
title: Dex (2)
writer: Harold
date: 2025-5-14 7:33:00 +0800
categories: [Udemy, SwiftUI]
tags: [SwiftUI]

toc: true
toc_sticky: true
---

## CoreDataë¡œ ë¶€í„° Fetch

ê·¸ì „ì— Controllerì—ì„œ

ë§ˆì§€ë§‰ ë¶€ë¶„ì—

`container.viewContext.mergePolicy = NSMergePolicy.mergeByPropertyStoreTrump` MergePolicyë¥¼ ì¶”ê°€í•´ì£¼ì.

[Docs](https://developer.apple.com/documentation/coredata/nsmergepolicy/mergebypropertystoretrump){:target="_blank"} ì°¸ê³ 

| Merge Policy                            | ì„¤ëª…                                                    | ìš°ì„ ìˆœìœ„           | ì‚¬ìš© ì˜ˆì‹œ                                       |
|----------------------------------------|---------------------------------------------------------|--------------------|------------------------------------------------|
| NSMergeByPropertyObjectTrumpMergePolicy | ë©”ëª¨ë¦¬(Context)ì˜ ë³€ê²½ê°’ì´ ì €ì¥ì†Œ(Store) ê°’ì„ ë®ì–´ì”€     | ë©”ëª¨ë¦¬ ìš°ì„         | ì‚¬ìš©ìê°€ ì…ë ¥í•œ ìµœì‹  ê°’ì„ ìœ ì§€í•˜ê³  ì‹¶ì„ ë•Œ       |
| NSMergeByPropertyStoreTrumpMergePolicy  | ì €ì¥ì†Œ(Store)ì˜ ê¸°ì¡´ ê°’ì„ ë©”ëª¨ë¦¬(Context) ë³€ê²½ë³´ë‹¤ ìœ ì§€ | ì €ì¥ì†Œ ìš°ì„         | ì„œë²„ ë™ê¸°í™” ìƒíƒœë¥¼ ì‹ ë¢°í•˜ê³  ì¶©ëŒì„ í”¼í•˜ê³  ì‹¶ì„ ë•Œ |

```swift
struct ContentView: View {
    @Environment(\.managedObjectContext) private var viewContext

    @FetchRequest(
        sortDescriptors: [NSSortDescriptor(keyPath: \Pokemon.id, ascending: true)],
        animation: .default)
    private var pokedex: FetchedResults<Pokemon>

    var body: some View {
        NavigationView {
            List {
                ForEach(pokedex) { pokemon in
                    NavigationLink {
                        Text(pokemon.name ?? "no name")
                    } label: {
                        Text(pokemon.name ?? "no name")
                    }
                }
                
            }
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    EditButton()
                }
                ToolbarItem {
                    Button("Add Item", systemImage: "plus") {
                        
                    }
                }
            }
        }
    }
}
```

ì´ë ‡ê²Œ ê¸°ë³¸í‹€ì„ ë‹¤ë“¬ì–´ ì¤€ë‹¤.


![Image](https://github.com/user-attachments/assets/28a0ea95-3a64-46fb-ae2b-35008d99a480){: width="50%" height="50%"}

ì—ëŸ¬ê°€ ëª¨ë‘ í•´ê²°ë˜ê³  Controllerì—ì„œ ë§Œë“  ì´ˆê¸°ê°’ì´ í˜„ì¬ Previewì— ë³´ì´ê²Œ ëœë‹¤.

## CodingKeys

ë­ CodingKeys ë¼ê³  ì ì—ˆì§€ë§Œ ì´ë¯¸ Modeling í•˜ë©´ì„œ ì‚¬ìš©í–ˆë˜ê²ƒì´ê¸°ì— í¬ê²Œ ë­ ì–¸ê¸‰í• ë§Œí•œê±´ ì—†ì–´ë³´ì¸ë‹¤.
(ì´ë•ŒëŠ” ëª°ëë‹¤.....)

[ì´ì „ê¸€](https://haroldfromk.github.io/posts/Build-the-unofficial-Udemy-Home-Screen-(8)/){:target="_blank"}ì—ì„œ ë¹„ìŠ·í•˜ê²Œ í•œì ì´ ìˆê¸´í•œë°.

```swift
struct FetchedPokemon: Decodable {
    let id: Int16
    let name: String
    let types: [String]
    let hp: Int16
    let attack: Int16
    let defense: Int16
    let specialAttack: Int16
    let specialDefense: Int16
    let speed: Int16
    let sprite: URL
    let shiny: URL
    
    enum CodingKeys: CodingKey {
        case id
        case name
        case types
        case stats
        case sprites
        
        enum TypeDictionaryKeys: CodingKey {
            case type
            
            enum TypeKeys: CodingKey {
                case name
            }
        }
        
        enum StatDictionaryKeys: CodingKey {
            case baseStat
        }
        
        enum SpriteKeys: String, CodingKey {
            case sprite = "frontDefault"
            case shiny = "frontShiny"
        }
    }
    init(from decoder: any Decoder) throws {
    let container = try decoder.container(keyedBy: CodingKeys.self)
    
    self.id = try container.decode(Int16.self, forKey: .id)
    self.name = try container.decode(String.self, forKey: .name)
    self.types = try container.decode([String].self, forKey: .types)
    self.hp = try container.decode(Int16.self, forKey: .hp)
    self.attack = try container.decode(Int16.self, forKey: .attack)
    self.defense = try container.decode(Int16.self, forKey: .defense)
    self.specialAttack = try container.decode(Int16.self, forKey: .specialAttack)
    self.specialDefense = try container.decode(Int16.self, forKey: .specialDefense)
    self.speed = try container.decode(Int16.self, forKey: .speed)
    self.sprite = try container.decode(URL.self, forKey: .sprite)
    self.shiny = try container.decode(URL.self, forKey: .shiny)
    }
}
```

ì—¬ê¸°ì„œ ëˆˆì—¬ê²¨ ë´ì•¼ í•  ê²ƒì€ 

CondingKeys ë¼ëŠ” enum ì•ˆì— ì—¬ëŸ¬ enumì„ ë˜ ì„¸ë¶„í™” í•œê±´ë° ì´ìœ ëŠ” jsonì— ìˆë‹¤.

![Image](https://github.com/user-attachments/assets/22dcc297-e17b-449a-af20-daaa68c4b44b)

í•´ë‹¹ ì‚¬ì§„ì„ ë³´ë©´ ì´ë ‡ê²Œ ì„¸ë¶€ì ìœ¼ë¡œ ë‚˜ë‰˜ì–´ì ¸ìˆëŠ”ë°

ì´ê²ƒì„ apië¥¼ í†µí•´ ê°€ì ¸ì˜¬ê²ƒì´ë¯€ë¡œ ìœ„ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•œ ê²ƒ.

![Image](https://github.com/user-attachments/assets/91113ecd-cfb9-4418-b8f5-1c3dcb1a95b4)

ì—¬ê¸°ì„œ initêµ¬ë¬¸ ë‚´ selfë¥¼ ëª¨ë‘ ì§€ì›Œì£¼ì ì´ë•Œ, í•œë²ˆì— ì§€ìš°ëŠ” ë°©ë²•ì´ ìˆëŠ”ë° Shift+Controlì„ ëˆ„ë¥¸ ìƒíƒœì—ì„œ ì´ë ‡ê²Œ ë‚´ë¦¬ë©´ ë‹¤ì¤‘ ì„ íƒ ì²˜ëŸ¼ ë˜ì–´ì„œ ë™ì‹œì— ì‚­ì œê°€ ê°€ëŠ¥í•˜ë‹¤.

```swift
init(from decoder: any Decoder) throws {
        let container = try decoder.container(keyedBy: CodingKeys.self)
        
        id = try container.decode(Int16.self, forKey: .id)
        
        name = try container.decode(String.self, forKey: .name)
        
        var decodedTypes: [String] = []
        var typesContainer = try container.nestedUnkeyedContainer(forKey: .types)
        
        while !typesContainer.isAtEnd {
            // Decode types
            let typesDictionaryContainer = try typesContainer.nestedContainer(keyedBy: CodingKeys.TypeDictionaryKeys.self)
            let typeContainer = try typesDictionaryContainer.nestedContainer(keyedBy: CodingKeys.TypeDictionaryKeys.TypeKeys.self, forKey: .type)
            
            let type = try typeContainer.decode(String.self, forKey: .name)
            decodedTypes.append(type)
        }
        types = decodedTypes

        var decodedStats: [Int16] = []
        var statsContainer = try container.nestedUnkeyedContainer(forKey: .stats)
        while !statsContainer.isAtEnd {
            let statsDictionaryContainer = try statsContainer.nestedContainer(keyedBy: CodingKeys.StatDictionaryKeys.self)
            let stat = try statsDictionaryContainer.decode(Int16.self, forKey: .baseStat)
            decodedStats.append(stat)
        }
        
        hp = decodedStats[0]
        attack =  decodedStats[1]
        defense =  decodedStats[2]
        specialAttack =  decodedStats[3]
        specialDefense =  decodedStats[4]
        speed =  decodedStats[5]
        
        let spriteContainer = try container.nestedContainer(keyedBy: CodingKeys.SpriteKeys.self, forKey: .sprites)
        
        sprite = try spriteContainer.decode(URL.self, forKey: .sprite)
        shiny = try spriteContainer.decode(URL.self, forKey: .shiny)
    }
```

ì´ë ‡ê²Œ ì½”ë“œë¥¼ ë°”ê¿”ì£¼ì—ˆë”°.

ì´ë¶€ë¶„ì€ ìƒì†Œí•œ ë¶€ë¶„ì´ê¸°ì— ì¡°ê¸ˆ ë” ìì„¸íˆ ì§šì–´ë³´ë„ë¡ í•œë‹¤.

---

### ğŸ§¬ `FetchedPokemon` êµ¬ì¡° ìš”ì•½

#### 1ï¸âƒ£ ì™œ `CodingKeys`ë¥¼ ê³„ì¸µì ìœ¼ë¡œ ë‚˜ëˆ„ì—ˆëŠ”ê°€?

ì¤‘ì²© JSON êµ¬ì¡°ì— ì •í™•íˆ ì ‘ê·¼í•˜ê¸° ìœ„í•´ ê° ê³„ì¸µë§ˆë‹¤ ë³„ë„ì˜ `CodingKey` enumì´ í•„ìš”í•˜ë‹¤.

| í•­ëª©      | JSON êµ¬ì¡° ì˜ˆì‹œ                                                                 | ì„¤ëª…                                                             | í•„ìš”í•œ í‚¤ enum                      |
|-----------|----------------------------------------------------------------------------------|------------------------------------------------------------------|-------------------------------------|
| `types`   | `[ { "type": { "name": "..." } } ]`                                              | ë°°ì—´ â†’ ë”•ì…”ë„ˆë¦¬ â†’ ë‚´ë¶€ ë”•ì…”ë„ˆë¦¬                                   | `TypeDictionaryKeys.TypeKeys`      |
| `stats`   | `[ { "base_stat": ..., "stat": { "name": "..." } } ]`                           | ë°°ì—´ â†’ ë”•ì…”ë„ˆë¦¬ (ê¸°ë³¸ê°’) â†’ ë‚´ë¶€ ë”•ì…”ë„ˆë¦¬ (ì´ë¦„ ë“± ì¶”ê°€ ì •ë³´ í¬í•¨) | `StatDictionaryKeys`               |
| `sprites` | `{ "sprites": { "front_default": "...", "front_shiny": "...", ... } }`          | ë”•ì…”ë„ˆë¦¬ â†’ ì—¬ëŸ¬ key â†’ URL (Swift ì†ì„±ê³¼ JSON key ì´ë¦„ì´ ë‹¤ë¦„)    | `SpriteKeys` (with `rawValue`)     |

> JSON ë‚´ë¶€ì— ì¤‘ì²©ëœ ë°°ì—´ì´ë‚˜ ë”•ì…”ë„ˆë¦¬ë¥¼ íŒŒì‹±í•˜ë ¤ë©´ Swiftì˜ `nested(Un)keyedContainer`ì™€ ê³„ì¸µì ì¸ `CodingKey` ì„¤ê³„ê°€ í•„ìˆ˜ì ì´ë‹¤.

---

#### 2ï¸âƒ£ ì™œ `init(from:)`ì„ ì§ì ‘ êµ¬í˜„í–ˆëŠ”ê°€?

ìë™ ìƒì„±ì´ JSON êµ¬ì¡°ì— ëŒ€ì‘í•˜ì§€ ëª»í•˜ê¸° ë•Œë¬¸.  
- ì¤‘ì²© êµ¬ì¡° (`types`, `stats`) â†’ ë°°ì—´ ì•ˆì— ë”•ì…”ë„ˆë¦¬ êµ¬ì¡°
- í‚¤ ì´ë¦„ ë¶ˆì¼ì¹˜ (`sprites`) â†’ `"front_default"` ë“± JSON keyê°€ Swift ë³€ìˆ˜ëª…ê³¼ ë‹¤ë¦„

---

#### 3ï¸âƒ£ ì£¼ìš” íë¦„ ì •ë¦¬

| í•­ëª©       | ì²˜ë¦¬ ë°©ì‹                                           |
|------------|-----------------------------------------------------|
| `id`, `name`  | ìƒìœ„ containerì—ì„œ ë°”ë¡œ ë””ì½”ë”©                       |
| `types`       | ë°°ì—´ â†’ ë”•ì…”ë„ˆë¦¬ â†’ ë‚´ë¶€ ë”•ì…”ë„ˆë¦¬ â†’ `name` â†’ `while` ë£¨í”„ |
| `stats`       | ë°°ì—´ â†’ ë”•ì…”ë„ˆë¦¬ â†’ `base_stat`ë§Œ ì¶”ì¶œ â†’ `while` ë£¨í”„     |
| `sprites`     | 1ë‹¨ê³„ nested container (`sprites`) + key ì´ë¦„ ë§¤í•‘     |

---

#### 4ï¸âƒ£ ì»¨í…Œì´ë„ˆ ì‚¬ìš© ìš”ì•½

| êµ¬ì¡°     | ë©”ì„œë“œ                   | ì˜ˆì‹œ                             |
|----------|--------------------------|----------------------------------|
| ë”•ì…”ë„ˆë¦¬  | `nestedContainer`        | `sprites`, `type`, `stat`       |
| ë°°ì—´      | `nestedUnkeyedContainer` | `types`, `stats`                |
| ë£¨í”„     | `while !container.isAtEnd` | ë°˜ë³µ ë””ì½”ë”©                     |
| ëˆ„ì      | `append()`               | ë°°ì—´ì— ê°’ ì¶”ê°€ (`types`, `stats`) |

---

#### ğŸ§© í•µì‹¬ ìš”ì•½

- ì¤‘ì²© JSON êµ¬ì¡° â†’ `CodingKeys`ë¥¼ ê³„ì¸µí™”í•˜ì—¬ ì •í™•íˆ ë§¤í•‘
- ìë™ ìƒì„± initì€ êµ¬ì¡° ëŒ€ì‘ ë¶ˆê°€ â†’ ìˆ˜ë™ êµ¬í˜„ í•„ìˆ˜
- `types`, `stats`, `sprites`ëŠ” ê°ê¸° ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼ ë° íŒŒì‹± í•„ìš”
- `nested(Un)keyedContainer`, `while` ë£¨í”„, `rawValue` ì‚¬ìš© ì´í•´ í•„ìˆ˜

---

### ğŸ“¦ `JSONDecoder.decode` vs `Decoder.container` - ì˜ˆì œ ê¸°ë°˜ ë¹„êµ

#### âœ… JSONDecoder.decode ë°©ì‹

**ì˜ˆì œ JSON (ë‹¨ìˆœ êµ¬ì¡°):**

```json
{
  "name": "Bulbasaur",
  "hp": 45,
  "attack": 49
}
```

**ì ìš© ì½”ë“œ:**

```swift
struct Pokemon: Decodable {
  let name: String
  let hp: Int
  let attack: Int
}

let result = try JSONDecoder().decode(Pokemon.self, from: data)
```
**íŠ¹ì§•:**
- JSON êµ¬ì¡°ê°€ í‰ë©´ì (flat)ì¼ ë•Œ ë§¤ìš° ê°„ë‹¨í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥
- ëª¨ë¸ êµ¬ì¡°ì™€ JSON êµ¬ì¡°ê°€ 1:1ë¡œ ëŒ€ì‘ë¨

---

#### âœ… Decoder.container ë°©ì‹

**ì˜ˆì œ JSON (ì¤‘ì²© êµ¬ì¡°):**

```json
{
  "pokemon": {
    "name": "Bulbasaur",
    "stats": {
      "hp": 45,
      "attack": 49
    }
  }
}
```

**ì ìš© ì½”ë“œ:**

```swift
struct PokemonStats: Decodable {
  let name: String
  let hp: Int

  enum RootKeys: String, CodingKey {
    case pokemon
  }

  enum PokemonKeys: String, CodingKey {
    case name
    case stats
  }

  enum StatsKeys: String, CodingKey {
    case hp
  }

  init(from decoder: Decoder) throws {
    let root = try decoder.container(keyedBy: RootKeys.self)
    let pokemon = try root.nestedContainer(keyedBy: PokemonKeys.self, forKey: .pokemon)
    name = try pokemon.decode(String.self, forKey: .name)

    let stats = try pokemon.nestedContainer(keyedBy: StatsKeys.self, forKey: .stats)
    hp = try stats.decode(Int.self, forKey: .hp)
  }
}
```

**íŠ¹ì§•:**
- ì¤‘ì²©ëœ êµ¬ì¡°ì—ì„œ í•„ìš”í•œ ê°’ë§Œ íŒŒì‹± ê°€ëŠ¥
- ì „ì²´ êµ¬ì¡°ë¥¼ ëª¨ë¸ë§í•˜ì§€ ì•Šì•„ë„ ë¨
- JSONì´ ë³µì¡í•˜ê±°ë‚˜ ì¼ë¶€ ê°’ë§Œ ì¶”ì¶œí•  ë•Œ ìœ ë¦¬

---

#### ğŸ“Œ ìš”ì•½ ë¹„êµí‘œ

| í•­ëª©                     | JSONDecoder.decode                        | Decoder.container                           |
|--------------------------|-------------------------------------------|---------------------------------------------|
| ì˜ˆì œ JSON êµ¬ì¡°           | í‰ë©´ì                                     | ì¤‘ì²© êµ¬ì¡°                                   |
| ì²˜ë¦¬ ëŒ€ìƒ                | ì „ì²´ êµ¬ì¡°                                 | í•„ìš”í•œ ê°’ë§Œ ì„ íƒì ìœ¼ë¡œ ì¶”ì¶œ                |
| ì‚¬ìš© ë‚œì´ë„              | ê°„ë‹¨í•˜ê³  ì§ê´€ì                            | ì •êµí•˜ê³  ìœ ì—°í•œ ì œì–´ ê°€ëŠ¥                   |
| ì í•©í•œ ìƒí™©              | ì „ì²´ êµ¬ì¡°ê°€ ë‹¨ìˆœí•˜ê³  ê·¸ëŒ€ë¡œ ì“¸ ìˆ˜ ìˆì„ ë•Œ | ì¼ë¶€ ê°’ë§Œ íŒŒì‹±í•˜ê±°ë‚˜ êµ¬ì¡°ê°€ ë³µì¡í•  ë•Œ       |

---

ë‹¤ìŒí¸ì—ì„œëŠ” ì‹¤ì œ JSON êµ¬ì¡°ë¥¼ ë°”íƒ•ìœ¼ë¡œ init ë””ì½”ë”©ì„ ì–´ë–»ê²Œ í•˜ëŠ”ì§€ ìì„¸íˆ ë³¸ë‹¤.