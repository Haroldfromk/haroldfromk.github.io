---
title: WidgetKit (10)
writer: Harold
date: 2024-12-09 17:13
categories: [WidgetKit, SwiftCal, CoreData]
tags: []

toc: true
toc_sticky: true
---

## App Group ì ìš©í•˜ê¸°

ì•±ê³¼ ìœ„ì ¯ì— ê°™ì€ CoreDataì˜ ê°’ì„ ê°™ì´ ì‚¬ìš©í•˜ê¸° ìœ„í•´ App Groupì„ ì‚¬ìš©í•´ ì¤€ë‹¤.

[ì´ì „ê¸€](https://haroldfromk.github.io/posts/Widget-(7)/){:target="_blank"}ì—ì„œ ê´€ë ¨ ë‚´ìš©ì„ ë‹¤ë¤˜ìœ¼ë‹ˆ í•œë²ˆ ë‹¤ì‹œ ë³´ëŠ”ê²ƒë„ ì¢‹ì„ë“¯.

ê·¸ì „ì— Widgetì„ ë§Œë“¤ì–´ ì¤€ë‹¤.

![CleanShot 2024-12-09 at 17 19 49](https://github.com/user-attachments/assets/7394fe4e-7e95-458f-bc4d-b1f61f403dae)

ë§Œë“œëŠ”ê±´ ì´ì‚¬ì§„ í•œì¥ìœ¼ë¡œ ëŒ€ì²´

App Group ë§Œë“œëŠ”ê²ƒë„ ì´ì „ì— ì–¸ê¸‰í–ˆìœ¼ë¯€ë¡œ ì•„ë˜ ì‚¬ì§„ìœ¼ë¡œ ëŒ€ì²´í•œë‹¤.

ì²«ë²ˆì§¸ëŠ” ì•±ì—ì„œ App Group ìƒì„±
![CleanShot 2024-12-09 at 17 24 55](https://github.com/user-attachments/assets/383fd5a0-4730-43cc-8155-706756dc17f8)

ë‘, ì„¸ë²ˆì§¸ëŠ” ìƒì„±ëœ App Groupì„ ìœ„ì ¯ì—ë„ ì ìš©
![CleanShot 2024-12-09 at 17 22 39](https://github.com/user-attachments/assets/63f0b5a0-0aba-4213-99f8-779ba96d2b80)
![CleanShot 2024-12-09 at 17 22 58](https://github.com/user-attachments/assets/b008c8a8-1b1c-4b5d-b22d-c7699eaed7d2)

## CoreDataì˜ Container Migration

ìœ„ì˜ ê³¼ì •ì„ í†µí•´ Shared Containerë¥¼ ìƒì„±í–ˆì§€ë§Œ, í˜„ì¬ CoreDataë¥¼ ê´€ë¦¬í•˜ëŠ” Persistence íŒŒì¼ì„ í™•ì¸í•´ ë³´ë©´ ì—¬ì „íˆ App Containerë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤. ì´ë¥¼ Shared Containerë¡œ ë³€ê²½í•˜ë ¤ë©´ Migration ì‘ì—…ì´ í•„ìš”í•˜ë‹¤.

![CleanShot 2024-12-09 at 17 30 01](https://github.com/user-attachments/assets/2a6d953b-e085-4bd6-abeb-ee3b98acb38c)

### Shared Container URL ìƒì„±

ë¨¼ì € Shared Container URLì„ ì •ì˜í•œë‹¤. ì´ URLì€ App Groupì„ í™œìš©í•˜ì—¬ CoreDataê°€ Shared Containerë¥¼ ì°¸ì¡°í•˜ë„ë¡ ì„¤ì •í•œë‹¤.

```swift
var sharedStoreURL: URL {
    let container = FileManager.default.containerURL(forSecurityApplicationGroupIdentifier: "group.HaroldSong.SwiftCal")!
    return (container.appendingPathComponent(databaseName))
    }
```
- forSecurityApplicationGroupIdentifier: App Groupì˜ ì‹ë³„ìë¥¼ ì§€ì •.
- appendingPathComponent: CoreData íŒŒì¼ ì´ë¦„(SwiftCal.sqlite)ì„ ì¶”ê°€.

ì´ë ‡ê²Œ URLì£¼ì†Œë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ ì¤€ë‹¤.

âš ï¸ ì°¸ê³ : appendingPathComponentëŠ” ê³§ Deprecatedë  ì˜ˆì •ìœ¼ë¡œ, [appending(path:directoryHint:)](https://developer.apple.com/documentation/foundation/url/3988449-appending){:target="_blank"}ë¥¼ ì‚¬ìš©í•  ê²ƒì„ ê¶Œì¥í•œë‹¤.

![CleanShot 2024-12-09 at 17 44 26](https://github.com/user-attachments/assets/5333ebe4-b044-4fd8-b4bc-f49360dbe852)

ì•ìœ¼ë¡œëŠ” ì´ê±¸ë¡œ ì‚¬ìš©í•˜ë©´ ë˜ê¸´í•œë‹¤.

```swift
var sharedStoreURL: URL {
        let container = FileManager.default.containerURL(forSecurityApplicationGroupIdentifier: "group.HaroldSong.SwiftCal")!
        return container.appending(path: databaseName, directoryHint: .notDirectory)
    }
```

ì´ë ‡ê²Œ í˜¼ìì„œ ë§Œë“¤ì–´ë³´ê¸´í–ˆëŠ”ë° ìš°ì„ ì€ í•´ë‹¹ë‚´ìš©ì€ ì ìš©í•˜ì§€ëŠ” ë§ì.

### Migration ë¬¸ì œì  ë° ëŒ€ì²˜ë°©ì•ˆ

![simulator_screenshot_2BA10C84-BA60-4BB4-B886-6640356F6C06](https://github.com/user-attachments/assets/6de20f1a-af63-4503-b9fe-a58243949689){: width="50%" height="50%"}

í˜„ì¬ App Containerì— ì €ì¥ëœ ë°ì´í„°ë¥¼ Shared Containerë¡œ ì˜®ê¸°ëŠ” ê³¼ì •ì—ì„œ, ì˜ëª»ëœ ì„¤ì •ì´ë‚˜ ì‹¤ìˆ˜ë¡œ ì¸í•´ ë°ì´í„°ê°€ ì†ì‹¤ë  ìœ„í—˜ì´ ìˆë‹¤. ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ê¸°ì¡´ ë°ì´í„°ì˜ URLì„ ë³„ë„ë¡œ ì •ì˜í•˜ê³  ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§ì„ ì¶”ê°€í•œë‹¤.

```swift
let databaseName = "SwiftCal.sqlite"

var oldStoreURL: URL {
    let directory = FileManager.default.urls(for: .applicationSupportDirectory, in: .userDomainMask).first!
    return directory.appendingPathComponent(databaseName)
}
```

ê·¸ë¦¬ê³  ifë¬¸ì„

```swift
if inMemory {
    container.persistentStoreDescriptions.first!.url = URL(fileURLWithPath: "/dev/null")
} else {
    container.persistentStoreDescriptions.first!.url = sharedStoreURL
}
```

ì—¬ê¸°ì— elseë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.

## Migration í•¨ìˆ˜ ìƒì„± ë° Migration ì ìš©

ê°•ì˜ì—ì„  ìš°ì„  CoreData ê°’ì„ ë¦¬ì…‹í•´ì£¼ê¸°ìœ„í•´ ì•±ì„ ì‚­ì œí•˜ê³  ì¬ì„¤ì¹˜ë¥¼ ì§„í–‰í–ˆë‹¤.

ê·¸ë¦¬ê³  ê¸°ì¡´ ë°ì´í„°ë¥¼ Shared Containerë¡œ ì˜®ê¸°ëŠ” Migration ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```swift
func migrateStore(for container: NSPersistentContainer) {
    print("â¡ï¸ went into migrateStore")
    let coordinator = container.persistentStoreCoordinator
    
    guard let oldStore = coordinator.persistentStore(for: oldStoreURL) else { return }
    print("ğŸ›¡ï¸ old store no longer exists")

    do {
        let _ = try coordinator.migratePersistentStore(oldStore, to: sharedStoreURL, type: .sqlite)
        print("ğŸ Migration Succesfully Done")
    } catch {
        fatalError("Unable to migrate to shared store.")
    }
    
    do {
        try FileManager.default.removeItem(at: oldStoreURL)
        print("ğŸ—‘ï¸ Old store deleted")
    } catch {
        print("Unable to delete old store")
    }
}
```

### CoreData ì´ˆê¸°í™” ì‹œ Migration ë¡œì§ ì¶”ê°€

CoreData ì´ˆê¸°í™”(init) ì‹œ ê¸°ì¡´ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³ , í•„ìš”í•œ ê²½ìš° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìˆ˜í–‰í•˜ê¸°ìœ„í•´ initì„ ìˆ˜ì •í•´ì¤€ë‹¤.

```swift
init(inMemory: Bool = false) {
    container = NSPersistentContainer(name: "SwiftCal")
    if inMemory {
        container.persistentStoreDescriptions.first!.url = URL(fileURLWithPath: "/dev/null")
    } else if !FileManager.default.fileExists(atPath: oldStoreURL.path) {
        print("ğŸ…ğŸ»old store Doesn't exist. Using new shared URL")
        container.persistentStoreDescriptions.first!.url = sharedStoreURL
    }
    
    print("ğŸ•¸ï¸ container URL = \(container.persistentStoreDescriptions.first!.url)")
    
    container.loadPersistentStores(completionHandler: { (storeDescription, error) in
        if let error = error as NSError? {
            fatalError("Unresolved error \(error), \(error.userInfo)")
        }
    })
    migrateStore(for: container)
    container.viewContext.automaticallyMergesChangesFromParent = true
}
```

### Migration ì§„í–‰ ê³¼ì •

ê·¸ë¦¬ê³  ì‹¤í–‰ì „ì— console í™•ì¸ì„ ìœ„í•´

```swift
//container.persistentStoreDescriptions.first!.url = sharedStoreURL

//migrateStore(for: container)
```

init ë‚´ë¶€ì˜ ìœ„ì™€ê°™ì´ ì£¼ì„ì„ ì¡ì•„ì£¼ì—ˆë‹¤.

#### ì˜ëª»ëœ Target ì„¤ì •ìœ¼ë¡œ ì¸í•œ ì—ëŸ¬ë°œìƒ

í•˜ì§€ë§Œ ì‹¤í–‰ì„ í•˜ë‹ˆ

```text
[S:1] Error received: Connection invalidated.
```

ì´ëŸ° ì—ëŸ¬ê°€ ë°œìƒ ì•„ë§ˆ CoreDataë¥¼ ìˆ˜ì •í•˜ë©´ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆê¸°ì— ë­”ê°€ ë†“ì¹œê²Œ ìˆëŠ”ì§€ í™•ì¸ì„ í•´ë³¸ë‹¤.

![CleanShot 2024-12-09 at 19 21 36](https://github.com/user-attachments/assets/37759ea6-3ee8-431d-a7f4-bdaabd6a676a)

ì½”ë“œìƒ ë¬¸ì œê°€ ì—†ì–´ í™•ì¸ì„ í•˜ë˜ ë„ì¤‘ WidgetExtensionì„ ë§Œë“¤ë©´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ë¶€ë¶„ì´ ì•±ì´ ì•„ë‹Œ ìœ„ì ¯ìœ¼ë¡œ ë˜ì–´ìˆìœ¼ë©´ì„œ ìƒê¸´ ì—ëŸ¬ì˜€ë‹¤...

#### Migration ì§„í–‰

ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ì‹¤í–‰í•˜ë‹ˆ ë‹¤ìŒê³¼ ê°™ì´ ë‚˜ì˜¨ë‹¤.

1. ì´ˆê¸°ì‹¤í–‰ (ì•±ì„ ì‚­ì œí›„ ì„¤ì¹˜)
- Old store Container ìƒì„±.
```text
ğŸ…ğŸ»old store Doesn't exist. Using new shared URL
ğŸ•¸ï¸ container URL = Optional(file:///Users/dongik/Library/Developer/CoreSimulator/Devices/ECF12B83-9492-49E4-B3E8-BD8B6338334F/data/Containers/Data/Application/6435F397-CA40-44F6-B5E7-9D977796E3FE/Library/Application%20Support/SwiftCal.sqlite)
```

2. ì¬ì‹¤í–‰ ë° ê°’ ì…ë ¥
- Old store Containerê°€ ì´ˆê¸°ì‹¤í–‰ìœ¼ë¡œ ì¸í•´ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ ì¡´ì¬ í•˜ì§€ ì•ŠëŠ” ë©”ì„¸ì§€ê°€ ì‚­ì œ
```text
ğŸ•¸ï¸ container URL = Optional(file:///Users/dongik/Library/Developer/CoreSimulator/Devices/ECF12B83-9492-49E4-B3E8-BD8B6338334F/data/Containers/Data/Application/7B738302-1C36-4B99-85C3-A9946AE2A17C/Library/Application%20Support/SwiftCal.sqlite)
```
- ì²«ë²ˆì¬ ì¤„ì´ ì‚¬ë¼ì¡Œë‹¤.
    - ì´ì œ ê°’ì„ ë„£ì–´ì£¼ë„ë¡ í•˜ì.
![simulator_screenshot_2A679F0A-8DA8-4B3D-AA95-4D69E3D288D5](https://github.com/user-attachments/assets/a309d5fa-47c3-448c-a0c8-80b0eeeacfc0){: width="50%" height="50%"} 

3. ì¬ì‹¤í–‰
- ë°ì´í„° ì •ìƒì ìœ¼ë¡œ ë“¤ì–´ì˜¨ ê²ƒ í™•ì¸.

4. Migration ì§„í–‰
- ì£¼ì„ì„ ê±¸ì—ˆë˜ê²ƒì„ í’€ê³  Migrationì„ ì§„í–‰í•œë‹¤.
```text
ğŸ•¸ï¸ container URL = Optional(file:///Users/dongik/Library/Developer/CoreSimulator/Devices/ECF12B83-9492-49E4-B3E8-BD8B6338334F/data/Containers/Data/Application/3C7F6B6B-C1FA-4AAC-BB0C-7EA1F6F27E2A/Library/Application%20Support/SwiftCal.sqlite)
â¡ï¸ went into migrateStore
ğŸ›¡ï¸ old store no longer exists
ğŸ Migration Succesfully Done
ğŸ—‘ï¸ Old store deleted
```
- container urlì´ ê¸°ì¡´ old store ë¡œ ë‚˜ì˜¤ì§€ë§Œ ì´í›„ Migrationì´ ì§„í–‰ì´ ë˜ì—ˆìŒ.

5. Migration ì´í›„ ì¬ì‹¤í–‰
```text
ğŸ…ğŸ»old store Doesn't exist. Using new shared URL
ğŸ•¸ï¸ container URL = Optional(file:///Users/dongik/Library/Developer/CoreSimulator/Devices/ECF12B83-9492-49E4-B3E8-BD8B6338334F/data/Containers/Shared/AppGroup/F00B2756-3D80-4FD0-AEDA-0F90A8DB58E9/SwiftCal.sqlite)
â¡ï¸ went into migrateStore
```
- ê¸°ì¡´ old storeê°€ ì‚­ì œê°€ ë¨.
- ì´ì œëŠ” Containerì˜ ì£¼ì†Œê°€ `AppGroup`ìœ¼ë¡œ ë°”ë€Œì–´ìˆëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.

## Widget UI ë””ìì¸

![CleanShot 2024-12-09 at 20 44 13](https://github.com/user-attachments/assets/6e74baf3-f991-4294-ad0e-b2f405f0db18)

ì´ë ‡ê²Œ ë””ìì¸ì„ í•  ì˜ˆì •ì´ë‹¤.

### CalendarView ì„¸ë¶„í™” í•˜ê¸°

ì§€ê¸ˆ ë‹¬ë ¥ì˜ ê²½ìš°, Widgetì—ì„œë„ ì‚¬ìš©í•˜ê¸°ì— ê¸°ì¡´ì— Appì— ìˆë˜ Viewë¥¼ Widgetì—ì„œë„ ì‚¬ìš©í•˜ê¸°ìœ„í•´ ì„¸ë¶„í™” í•´ì¤€ë‹¤.

ì´ë•Œ ìœ„ì ¯ ì•± ì „ë¶€ ì‚¬ìš©í•´ì•¼í•˜ê¸°ì— Target ì²´í¬ë¥¼ í™•ì‹¤í•˜ê²Œ í•´ì¤€ë‹¤.

![CleanShot 2024-12-09 at 20 48 39](https://github.com/user-attachments/assets/d6108337-aa0e-4c4f-b6c4-673239e6503b)

```swift
let daysOfWeek = ["S", "M", "T", "W", "T", "F", "S"]
var font: Font = .body

var body: some View {
    HStack {
        ForEach(daysOfWeek, id: \.self) { dayOfWeek in
            Text(dayOfWeek)
                .font(font)
                .fontWeight(.black)
                .foregroundStyle(.orange)
                .frame(maxWidth: .infinity)
        }
    }
}
```

ì´ë ‡ê²Œ ìœ„ì˜ ìš”ì¼ì„ ë‚˜íƒ€ë‚´ëŠ” Headerë¥¼ ë³„ë„ë¡œ ë¶„ë¦¬í•´ì¤€ë‹¤.

### Widget Design

```swift
let columns = Array(repeating: GridItem(.flexible()), count: 7)
    
    var body: some View {
        HStack {
            VStack {
                Text("30")
                    .font(.system(size: 70, design: .rounded))
                    .bold()
                    .foregroundStyle(.orange)
                
                Text("day streak")
                    .font(.caption)
                    .foregroundStyle(.orange)
            }
            
            VStack {
                CalendarHeaderView(font: .caption)
                LazyVGrid(columns: columns, spacing: 7) {
                    ForEach(0..<31) { _ in
                        Text("30")
                            .font(.caption2)
                            .bold()
                            .frame(maxWidth: .infinity)
                            .foregroundStyle(.secondary)
                            .background {
                                Circle()
                                    .foregroundStyle(.orange.opacity(0.3))
                                    .scaleEffect(1.5)
                            }
                    }
                }
            }
            .padding(.leading, 6)
        }
        .padding()
    }
```

ì´ë ‡ê²Œ í•˜ë©´ 

![CleanShot 2024-12-10 at 01 48 23](https://github.com/user-attachments/assets/87926fee-1fda-464c-a244-972895feb119)

ì´ëŸ° ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.