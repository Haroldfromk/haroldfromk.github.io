---
title: WidgetKit (3)
writer: Harold
date: 2024-12-04 00:13
categories: [WidgetKit, RepoWatcher]
tags: []

toc: true
toc_sticky: true
---

## UI Design

ì´ë¶€ë¶„ì€ ìƒëµ

ë‹¤ë§Œ í•œê°€ì§€ íŠ¹ì´ì ì´ë¼ë©´

```swift
HStack {
    StatLabel(value: 999, systemImageName: "star.fill")
    StatLabel(value: 99, systemImageName: "tuningfork")
    StatLabel(value: 999, systemImageName: "exclamationmark.triangle.fill")
}


fileprivate struct StatLabel: View {
    
    let value: Int
    let systemImageName: String
    
    var body: some View {
        Label {
            Text("\(value)")
                .font(.footnote)
        } icon: {
            Image(systemName: systemImageName)
                .foregroundStyle(.green)
        }
        .fontWeight(.medium)
    }
}
```

StatLabelì— ëŒ€í•´ fileprivateê°€ ê±¸ë ¸ëŠ”ë°, ì´ë ‡ê²Œ ë˜ë©´ í•´ë‹¹ structë¥¼ ê°€ì§€ê³  ìˆëŠ” íŒŒì¼ ì•ˆì—ì„œë§Œ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.

ì¦‰ ë¬´ì‘ì • ì‚¬ìš©ì´ ì•ˆë˜ê¸°ë•Œë¬¸ì— ì½”ë“œ í˜¼ì„ ì„ ë°©ì§€í• ìˆ˜ìˆìŒ.

ê·¸ë¦¬ê³  ê°•ì˜ì—ì„  HStackì˜ paddingì„ Defaultë¡œ í•˜ì˜€ìœ¼ë‚˜, ê·¸ë ‡ê²Œ í•˜ë‹ˆ ì¡°ê¸ˆ ì•ˆë§ëŠ” ë¶€ë¶„ì´ ìˆì–´ `.padding(7)`ì´ë ‡ê²Œ ìˆ˜ì •í•œë‹¤.

![CleanShot 2024-12-04 at 15 37 03](https://github.com/user-attachments/assets/237a4f3b-be46-49f9-98b9-78943f8dff2b){: width="50%" height="50%"} 

ì´ˆê¸°í™”ë©´ ì„¸íŒ… ì™„ë£Œ.

ê·¸ë¦¬ê³  previewì˜ ê²½ìš° í˜„ì¬ì™€ ì´ì „ë²„ì „ì´ ë‹¤ë¥¸ë°

ìœ„ì ¯ì˜ ì‚¬ì´ì¦ˆë¥¼ ë³€ê²½í•˜ê³  ì‹¶ë‹¤ë©´

```swift
#Preview(as: .systemMedium) {
    RepoWatcherWidget()
} timeline: {
    SimpleEntry(date: .now, emoji: "ğŸ˜€")
    SimpleEntry(date: .now, emoji: "ğŸ¤©")
}
```

ì—¬ê¸°ì„œ as ë’¤ì— ì›í•˜ëŠ” ì‚¬ì´ì¦ˆë¥¼ ì •í•˜ì

ì²˜ìŒì— í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ë©´ `systemSmall`ì´ë‹¤.

## Api ëª¨ë¸ë§

GitHub Apië¥¼ ì‚¬ìš©í• ê²ƒì´ë‹¤

ìš°ì„  [Docs](https://docs.github.com/en/rest/repos/repos){:target="_blank"}ë¥¼ ë³´ë©´ì„œ í•˜ëŠ”ê²Œ ì¢‹ë‹¤.

ì´ë•Œ 

![CleanShot 2024-12-04 at 15 45 49](https://github.com/user-attachments/assets/539e4933-a8b9-4903-9a7a-956bede3e217)

Apiê´€ë ¨ Docsë¥¼ ë³´ë©´ í•­ìƒ cURLì— ëŒ€í•œ ë‚´ìš©ì´ ìˆë‹¤.

ì´ê±´ í„°ë¯¸ë„ì—ì„œ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.

í•œë²ˆ í™•ì¸í•´ë³´ì

ownerì™€ repoë§Œ ì‹¤ì œ ì¡´ì¬í•˜ëŠ”ê±¸ë¡œ ë°”ê¿”ì£¼ë©´ ëœë‹¤.

ë‚˜ì˜ ê³„ì •ì—ì„œ ForSwiftUI repositoryì— ê´€í•œ ë‚´ìš©ì„ ì ìš©í•´ë³´ê² ë‹¤.

![CleanShot 2024-12-04 at 15 48 35](https://github.com/user-attachments/assets/ecd393a3-8ba3-49ac-b305-d8e17b0079af)

ì´ë ‡ê²Œ ë°”ë¡œ ì¶œë ¥ì´ ë˜ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.

ì´ì œ ëª¨ë¸ë§ì„ í•´ë³´ì

```swift
struct Repository: Decodable {
    let name: String
    let owner: Owner
    let hasIssues: Bool
    let forks: Int
    let watchers: Int
    let openIssues: Int
    let pushedAt: String
}

struct Owner: Decodable {
    let avatarUrl: String
}
```

## Entry ì ìš©

ì´ì œ ëª¨ë¸ë§ì„ í•œê²ƒì„ Entryì— ì ìš©ì„ í•˜ì.

![CleanShot 2024-12-04 at 15 53 00](https://github.com/user-attachments/assets/dec2e98d-daf9-41a3-9e9b-62e3634fb633)

ê°€ì¥ ì‹¬í”Œí•œê±´ ì²˜ìŒì— ë§Œë“¤ì–´ì§€ëŠ” SimpleEntryë¥¼ Refactorë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¦„ì„ ë³€ê²½í•´ì£¼ëŠ”ê²ƒì´ë‹¤.

ê·¸ë¦¬ê³  repoë¥¼ ì¶”ê°€.

```swift
struct RepoEntry: TimelineEntry {
    let date: Date
    let repo: Repository // added
}
```

ì´ë•Œ ì—¬ëŸ¬ ì—ëŸ¬ê°€ ë°œìƒ 

placeholderì— DummyDataë¥¼ ì£¼ê¸° ìœ„í•´

```swift
struct Repository: Decodable {
    static let placeholder = Repository(name: "Your Repo",
                                        owner: Owner(avatarUrl: ""),
                                        hasIssues: true, forks: 65,
                                        watchers: 123,
                                        openIssues: 55,
                                        pushedAt: "2024-12-04T05:22:15Z"
                                        )
}
```

placeholderìš© ë³€ìˆ˜ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì£¼ì.

ì´ì œ ì´ê±¸ ì ìš©í•˜ë©´

```swift
struct Provider: TimelineProvider {
    func placeholder(in context: Context) -> RepoEntry {
        RepoEntry(date: Date(), repo: Repository.placeholder)
    }
    
    func getSnapshot(in context: Context, completion: @escaping (RepoEntry) -> ()) {
        let entry = RepoEntry(date: Date(), repo: Repository.placeholder)
        completion(entry)
    }

    func getTimeline(in context: Context, completion: @escaping (Timeline<Entry>) -> ()) {
    var entries: [RepoEntry] = []
    
    // ì¤‘ê°„ë¶€ë¶„ ì‚­ì œ

    let timeline = Timeline(entries: entries, policy: .atEnd)
    completion(timeline)
    }
}

VStack(alignment: .leading) {
    HStack {
        Circle()
            .frame(width: 50, height: 50)
        
        Text(entry.repo.name)
            .font(.title2)
            .fontWeight(.semibold)
            .minimumScaleFactor(0.6)
            .lineLimit(1)
    }
    .padding(.bottom, 6)
    
    HStack {
        StatLabel(value: entry.repo.watchers, systemImageName: "star.fill")
        StatLabel(value: entry.repo.forks, systemImageName: "tuningfork")
        StatLabel(value: entry.repo.openIssues, systemImageName: "exclamationmark.triangle.fill")
    }

#Preview(as: .systemMedium) {
    RepoWatcherWidget()
} timeline: {
    RepoEntry(date: .now, repo: Repository.placeholder)
}
```

ì²«ë²ˆì§¸: providerì— repoë¥¼ ì¶”ê°€ ê·¸ë¦¬ê³  timelineì˜ ì¤‘ê°„ for loopë‚´ìš© ì‚­ì œ

ë‘ë²ˆì§¸: valueê°’ì„ 999ê°™ì€ ì„ì˜ì˜ ìˆ«ìê°€ ì•„ë‹Œ entryì—ì„œ ê°€ì ¸ì˜¤ê²Œ ìˆ˜ì •

ì„¸ë²ˆì§¸: previewì—ì„œ timelineì„ ìˆ˜ì •í•˜ì—¬ dummy ì ìš©

![CleanShot 2024-12-04 at 16 05 08](https://github.com/user-attachments/assets/3fc109ce-1fc6-475f-91f4-2c62be14cc4c){: width="50%" height="50%"} 

ì´ë ‡ê²Œ ì ìš©ì´ ëœë‹¤.

## ë§ˆì§€ë§‰í™œë™ ê³„ì‚° í•¨ìˆ˜ ë§Œë“¤ê¸°

terminalì˜ ê²°ê³¼ë¥¼ ë³´ë©´

```shell
  "created_at": "2024-10-15T20:10:29Z",
  "updated_at": "2024-12-04T05:22:15Z",
  "pushed_at": "2024-12-04T05:22:11Z",
```

ì´ë ‡ê²Œ ì–¸ì œ pushê°€ ë˜ì—ˆëŠ”ì§€ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.

ì´ê±¸ í†µí•´ì„œ ë§ˆì§€ë§‰ìœ¼ë¡œ í™œë™í•œ ì¼ìë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ê³  ì ìš©ì„ í•´ë³´ë„ë¡ í•œë‹¤.

```swift
func calculateDaysSinceLastActivity(from dateString: String) -> Int {
    let formatter = ISO8601DateFormatter()
    let lastActivityDate = formatter.date(from: dateString) ?? .now
    let daysSinceLastActivity = Calendar.current.dateComponents([.day], from: lastActivityDate, to: .now).day ?? 0
    return daysSinceLastActivity
}
```

ì´ë•Œ ë‹¤ë¥¸ê±´ íŠ¹ì´ì‚¬í•­ì´ ì—†ì§€ë§Œ

ë°”ë¡œ ìƒˆë¡œìš´ formatterê°€ ë‚˜íƒ€ë‚˜ë‹¤.

[ISO8601DateFormatter Docs](https://developer.apple.com/documentation/foundation/iso8601dateformatter){:target="_blank"}ë¥¼ ì½ì–´ë³´ì

**2024-10-15T20:10:29Z** ì´ë ‡ê²Œ ì¶œë ¥ë˜ëŠ” í˜•ì‹ì´ ë°”ë¡œ ISO8601 í˜•ì‹ì´ë‹¤.

![](https://support.thoughtindustries.com/hc/article_attachments/16108386632727)

ì—¬ê¸° ê°„ëµí•œ ì„¤ëª…ì´ ìˆìœ¼ë‹ˆ ì°¸ê³ .

ë‹¤ì‹œëŒì•„ì™€ì„œ í˜„ì¬ githubì—ì„œ ì“°ëŠ” ì‹œê°„ì˜ í˜•ì‹ì€ ISO8601ì´ë‹¤.

ê·¸ë˜ì„œ í•´ë‹¹ formatterë¥¼ ì‚¬ìš©.

í•˜ì§€ë§Œ í•¨ìˆ˜ì•ˆì—ì„œ formatterë¥¼ ì‚¬ìš©í•˜ëŠ”ê²ƒ ë³´ë‹¤ëŠ” ë˜ ì‚¬ìš©í• ìˆ˜ ìˆìœ¼ë¯€ë¡œ viewì— ì„ ì–¸ì„ í•˜ê³ 

ë‚ ì§œë¥¼ ê³„ì‚°í•œ ê°’ì„ computed propertyë¥¼ ì‚¬ìš©í•´ ë§Œë“¤ì–´ì£¼ì

```swift
let formatter = ISO8601DateFormatter()
var daysSinceLastAcitivity: Int {
    calculateDaysSinceLastActivity(from: entry.repo.pushedAt)
}
```

ê·¸ë¦¬ê³  ê·¸ê±¸ ë‚ ì§œë¥¼ ì•Œë ¤ì£¼ëŠ” Textì— ì ìš©

```swift
VStack {
    Text("\(daysSinceLastAcitivity)")
        .bold()
        .font(.system(size: 70))
        .frame(width: 90)
        .minimumScaleFactor(0.6)
        .lineLimit(1)
        .foregroundStyle(daysSinceLastAcitivity > 50 ? .pink : .green)
```

foregroundStyleì— ì‚¼í•­ ì—°ì‚°ìë¥¼ í†µí•´ ì—…ë°ì´íŠ¸í•˜ê³  50ì¼ì´ ì´ˆê³¼í–ˆë‹¤ë©´ í•‘í¬, ì•„ë‹ˆë©´ ì´ˆë¡ìœ¼ë¡œ êµ¬ì„±í–ˆë‹¤.

![CleanShot 2024-12-04 at 17 05 16](https://github.com/user-attachments/assets/ff2c46d4-0127-4c92-892c-b81812ac2b01) ![CleanShot 2024-12-04 at 17 04 52](https://github.com/user-attachments/assets/6f3f0303-7540-4e35-b7ed-6edecd8957f7)

ì´ë ‡ê²Œ ëœë‹¤.

Dummyë¥¼ ë°”ê¾¸ë ¤ë©´ 

`struct Repository` ì—¬ê¸°ì„œ ë°”ê¾¸ë©´ ëœë‹¤

ì´ë¯¸ ë§Œë“¤ì–´ ë’€ìœ¼ë‹ˆê¹Œ.

## NetworkManager ë§Œë“¤ê¸°

ì´ì œ Apië¥¼ í˜¸ì¶œí•˜ëŠ”ê±¸ í•´ë³¼ê²ƒì´ë‹¤.

```swift
class NetworkManager {
    
    static let shared = NetworkManager()
    let decoder = JSONDecoder()
    
    private init() {
        decoder.keyDecodingStrategy = .convertFromSnakeCase
        decoder.dateDecodingStrategy = .iso8601
    }
    
    func getRepo(atUrl urlString: String) async throws -> Repository {
        
        guard let url = URL(string: urlString) else {
            throw NetworkError.invalidRepoURL
        }
        
        let (data, response) = try await URLSession.shared.data(from: url)
        
        guard let response = response as? HTTPURLResponse, response.statusCode == 200 else {
            throw NetworkError.invalidResponse
        }
        
        do {
            return try decoder.decode(Repository.self, from: data)
        } catch {
            throw NetworkError.invalidRepoData
        }
    }
    
}

enum NetworkError: Error {
    case invalidRepoURL
    case invalidResponse
    case invalidRepoData
}

enum RepoURL {
    static let swiftUIStudy = "https://api.github.com/repos/haroldfromk/ForSwiftUI"
    static let swiftAlgorithms = "https://api.github.com/repos/TheAlgorithms/Swift"
    static let google = "https://api.github.com/repos/google/GoogleSignIn-iOS"
}
```

ì—¬ê¸°ì„œ íŠ¹ì´ì ì€ ë°”ë¡œ initì„ í• ë•Œ decoderì— ì„¤ì •ì„ í•´ì¤€ê²ƒì´ë‹¤.

![CleanShot 2024-12-04 at 17 19 13](https://github.com/user-attachments/assets/510a213b-a790-4255-9132-637818ff811d)

ì‚¬ì§„ì€ `convertFromSnakeCase`ì˜ ì¼ë¶€ë¥¼ ê°€ì ¸ì™”ëŠ”ë°

ìœ„ì™€ ê°™ì´ ë””ì½”ë”©ì„ í• ë•Œ ë³€í™˜ì„ ìì—°ìŠ¤ëŸ½ê²Œ í•´ì¤€ë‹¤ëŠ” ê²ƒì´ë‹¤.

ë‚ ì§œ ê´€ë ¨í•´ì„œ ë””ì½”ë”©ì€ iso8601ìœ¼ë¡œ í•œë‹¤ëŠ”ê²ƒ.

í˜„ì¬ í˜¸ì¶œë˜ì–´ì„œ ê°€ì ¸ì˜¤ëŠ” jsonì˜ `avatar_url`ì˜ ê²½ìš° CamelCaseì˜ í˜•ì‹ì„ ë”°ë¥´ì§€ ì•ŠëŠ”ë‹¤.

ê·¸ë¦¬ê³  ìš°ë¦¬ëŠ” 

```swift
struct Owner: Decodable {
    let avatarUrl: String
}
```

ê·¸ëƒ¥ ì´ë ‡ê²Œ ì¼ë‹¤.

ì´ì „ì´ì—ˆìœ¼ë©´ CodingKeyë¥¼ ì‚¬ìš©í•´ì„œ í•´ê²°í–ˆë‹¤.

```swift
struct Owner: Decodable {
    let avatarUrl: String
    
    enum CodingKeys: String, CodingKey {
        case avatarUrl = "avatar_url"
    }

}
```

í•˜ì§€ë§Œ ì§€ê¸ˆì€ ê·¸ë ‡ê²Œ í•˜ì§€ ì•Šì•˜ë‹¤.

ë””ì½”ë”ì—ì„œ ì„¤ì •ì„ í•´ì£¼ë©´ í•˜ì§€ì•Šì•„ë„ ëœë‹¤ëŠ”ê²ƒ.

## TimeLineì— ì ìš©

```swift
func getTimeline(in context: Context, completion: @escaping (Timeline<Entry>) -> ()) {
    Task {
        let nextUpdate = Date().addingTimeInterval(43200) // 12 hours in seconds
        
        do {
            let repo = try await NetworkManager.shared.getRepo(atUrl: RepoURL.swiftUIStudy)
            let entry = RepoEntry(date: .now, repo: repo)
            let timeline = Timeline(entries: [entry], policy: .after(nextUpdate)) // update every 12hours
            completion(timeline)
        }
        catch {
            print("âŒ Error - \(error.localizedDescription)")
        }

    }
}
```

ì´ë•Œ timeLine ë³€ìˆ˜ë¥¼ ì¢€ ë°”ê¿”ì£¼ì—ˆëŠ”ë°, 12ì‹œê°„ë§ˆë‹¤ ì—…ë°ì´íŠ¸ë¥¼ í•˜ê¸°ìœ„í•´ ìœ„ì™€ ê°™ì´ í•´ì¤€ë‹¤.

ì´ë•Œ ì•ˆì— ë“¤ì–´ê°€ëŠ”ê±´ ì´ˆë‹¨ìœ„ ì´ë¯€ë¡œ nextUpdateì— ë‹¤ìŒê³¼ ê°™ì´ í–ˆë‹¤.

ìœ„ì ¯ì„ ì ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë‚˜ì˜¨ë‹¤.

![simulator_screenshot_53B95DEE-73B3-442A-B49A-2A46DEAC6E6C](https://github.com/user-attachments/assets/00cb26cb-24fd-44c3-92ae-28c09a2740f9){: width="50%" height="50%"} 

## Ownerì˜ Avatar ê°€ì ¸ì˜¤ê¸°

### NewworkManager
```swift
    func downloadImageData(from urlString: String) async -> Data? {
        guard let url = URL(string: urlString) else {
            return nil
        }
        
        do {
            let (data, _) = try await URLSession.shared.data(from: url)
            return data
        } catch {
            return nil
        }
    }
```

ì´ë ‡ê²Œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.

ì„¤ëª…ì€ íŒ¨ìŠ¤

### Timeline

ì´í›„ TimeLineì— ì¶”ê°€ë¥¼ í•´ì£¼ê³ ,

```swift
do {
    let repo = try await NetworkManager.shared.getRepo(atUrl: RepoURL.google)
    let avatarImageData = await NetworkManager.shared.downloadImageData(from: repo.owner.avatarUrl) // new
    let entry = RepoEntry(date: .now, repo: repo)
    let timeline = Timeline(entries: [entry], policy: .after(nextUpdate)) // update every 12hours
    completion(timeline)
}
```

### Entry

ì´ì œ Entryì—ë„ ì ìš©ì„ í•´ì£¼ì

```swift
struct RepoEntry: TimelineEntry {
    let date: Date
    let repo: Repository
    let avatarImageData: Data
}
```

ê·¸ëŸ¬ë©´ ìƒˆë¡œìš´ parameterê°€ ìƒê¸°ë‹ˆ ì—ëŸ¬ê°€ ë°œìƒí•˜ê³  ì´ì œ ê·¸ë¶€ë¶„ì„ ìˆ˜ì •í•´ì£¼ì.

![CleanShot 2024-12-04 at 17 48 28](https://github.com/user-attachments/assets/448e91f6-80dc-44d9-8461-44d5b4aaa018)

ì‹¤ì œë¡œ í•„ìš”í•œ ë¶€ë¶„ë§Œ 
`let entry = RepoEntry(date: .now, repo: repo, avatarImageData: avatarImageData!)` ì´ë ‡ê²Œ ê°’ì„ ë„£ì–´ì£¼ê³ 

ë‚˜ë¨¸ì§€ëŠ” ë¯¸ë¦¬ë³´ê¸° ìš©ì´ê¸°ì—

`RepoEntry(date: Date(), repo: Repository.placeholder, avatarImageData: Data())`

ì´ëŸ°ì‹ìœ¼ë¡œ `Data()`ë¡œ ëŒ€ì²´í•œë‹¤.

## ê°€ì ¸ì˜¨ Image ì ìš©í•˜ê¸°

AsyncImageëŠ” Widgetì—ì„œëŠ” ì‚¬ìš©ì´ ì•ˆëœë‹¤.

ê·¸ë˜ì„œ ì¼ë°˜ì ì¸ Imageë¥¼ ì‚¬ìš©í•´ì•¼í•œë‹¤.

Circleë¡œ í–ˆë˜ë¶€ë¶„ì„ ì´ì œ Imageë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€ì²´í•œë‹¤.

```swift
Image(uiImage: UIImage(data: entry.avatarImageData) ?? UIImage(named: "avatar")!)
    .resizable()
    .frame(width: 50, height: 50)
    .clipShape(Circle())
```

## placeholder ì‘ë™í™•ì¸

Timelineì˜
`let entry = RepoEntry(date: .now, repo: repo, avatarImageData: avatarImageData!)`
ì—¬ê¸°ì—ì„œ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì•„ê¹Œ ì „ì— ì ìš©í–ˆë˜ê²ƒì²˜ëŸ¼ Data()ë¡œ ë°”ê¿”ì„œ ì‘ë™í™•ì¸ì„ í•´ë³´ì

![CleanShot 2024-12-04 at 18 08 03](https://github.com/user-attachments/assets/135b5458-3386-4f94-a276-090dc2e39d29)

í™•ì¸ ì™„ë£Œ

ë°ì´í„°ê°€ nilì¼ë•Œë¥¼ ëŒ€ë¹„í•˜ì—¬

`let entry = RepoEntry(date: .now, repo: repo, avatarImageData: avatarImageData ?? Data())`

ì´ë ‡ê²Œ ì˜µì…”ë„ ë°”ì¸ë”©ì„ í•´ì£¼ì.

![CleanShot 2024-12-04 at 18 09 14](https://github.com/user-attachments/assets/5926c29e-b86e-423e-9407-92535991766d)

ì‹¤í–‰í•˜ë©´ ì˜ë˜ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.