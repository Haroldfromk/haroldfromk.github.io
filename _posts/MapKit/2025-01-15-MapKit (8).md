---
title: MapKit (8)
writer: Harold
date: 2025-01-15 08:06
categories: [MapKit]
tags: []

toc: true
toc_sticky: true
---

## LoadingView ë§Œë“¤ê¸°

[ì´ì „ì—](https://haroldfromk.github.io/posts/Final-(11)/){:target="_blank"}ëŠ” ProgresHUD Libraryë¥¼ í†µí•´ì„œ ë¡œë”©í•˜ëŠ” ê²ƒì„ í‘œí˜„í–ˆëŠ”ë°, ì—¬ê¸°ì„œëŠ” ë³„ë„ì˜ Viewë¥¼ ë§Œë“¤ì–´ì„œ ê´€ë¦¬í•œë‹¤.

```swift
struct LoadingView: View {
    var body: some View {
        ZStack {
            Color(.systemBackground)
                .opacity(0.9)
                .ignoresSafeArea()
            
            ProgressView()
                .progressViewStyle(CircularProgressViewStyle(tint: .brandPrimary))
                .scaleEffect(2)
                .offset(y: -40)
        }
    }
}
```

![Image](https://github.com/user-attachments/assets/6ff971b3-9b08-467d-be67-160b08e77b04){: width="50%" height="50%"} 

ê·¸ëŸ¼ ì´ë ‡ê²Œ ëŒì•„ê°€ëŠ”ê±¸ ë³¼ ìˆ˜ ìˆë‹¤.

profileViewModelë¡œê°€ì„œ

```swift
@Published var isLoading = false

private func showLoadingView() {
    isLoading = true
}

private func hideLoadingView() {
    isLoading = false
}
```

loadingì˜ ìƒíƒœë¥¼ ì•Œë ¤ì£¼ëŠ” ë³€ìˆ˜ì™€ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤.

ê·¸ë¦¬ê³  createProfile, getProfile í•¨ìˆ˜ì— ìœ„ì— ë§Œë“¤ì–´ë‘” í•¨ìˆ˜ë¥¼ ë„£ì–´ì¤€ë‹¤.

```swift
func createProfile() {
        // ìƒëµ
        
        userRecord["userProfile"] = CKRecord.Reference(recordID: profileRecord.recordID, action: .none)
        
        showLoadingView() //new
        CloudKitManager.shared.batchSave(records: [userRecord, profileRecord]) { result in
            DispatchQueue.main.async { [self] in
                hideLoadingView() // new
                switch result {
                    
                case .success(_):
                    // show alert
                    
                    break
                case .failure(_):
                    // show alert
                    
                    break
                }
            }
            
        }

}
```

getProfile í•¨ìˆ˜ì—ì„œë„ ìœ„ì¹˜ëŠ” ë™ì¼í•˜ë¯€ë¡œ ì½”ë“œ ê¸¸ì´ìƒ í•˜ë‚˜ì˜ í•¨ìˆ˜ì—ë§Œ ì ì–´ë‘”ë‹¤.

ProfileViewì—ì„œë„ ì ìš©ì„ í•´ì£¼ì.

```swift
struct ProfileView: View {
    // ìƒëµ
    var body: some View {
        ZStack { // new
            VStack {
                // ìƒëµ
            }
            // new
            if viewModel.isLoading {
                LoadingView()
            }
            
        }
    }

}
```

Zstackì„ ë§Œë“¤ê³  true / falseì—ë”°ë¼ LoadingViewë¥¼ ë³´ì—¬ì¤„ì§€ ë§ì§€ì— ëŒ€í•´ ì •í•˜ë©´ ëœë‹¤.

![Image](https://github.com/user-attachments/assets/cdafdd4e-2ffc-409b-9a7e-8f24198cb147){: width="50%" height="50%"} 

ì‹¤í–‰í•˜ë©´ ì´ë ‡ê²Œ ë¡œë”©ë·°ê°€ ë³´ì´ê³  ì‚¬ë¼ì§€ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.

## Alert ì¶”ê°€í•˜ê¸°

AlertItemì—ì„œ Alertë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤.

```swift
static let invalidProfile = AlertItem( // ìƒëµ
)

static let noUserRecord = AlertItem( // ìƒëµ
)

static let createProfileSuccess = AlertItem( // ìƒëµ
)

static let createProfileFailure = AlertItem( // ìƒëµ
)

static let unableToGetProfile = AlertItem( // ìƒëµ
)
```

ê·¸ë¦¬ê³  ì´ëŸ°ì‹ìœ¼ë¡œ AlertItemì„ ì ìš©í•´ì¤€ë‹¤.

```swift
CloudKitManager.shared.batchSave(records: [userRecord, profileRecord]) { result in
    DispatchQueue.main.async { [self] in
        hideLoadingView()
        switch result {
            
        case .success(_):
            alertItem = AlertContext.createProfileSuccess
        case .failure(_):
            alertItem = AlertContext.createProfileFailure
            
            break
        }
    }
    
}
```

ë‚˜ë¨¸ì§€ëŠ” ìƒëµ!

## Profile Update

```swift
// ViewModel
func save(record: CKRecord, completed: @escaping (Result<CKRecord, Error>) -> Void) {
    CKContainer.default().publicCloudDatabase.save(record) { record, error in
        guard let record = record, error == nil else {
            completed(.failure(error!))
            return
        }
        
        completed(.success(record))
    }
}
```

í”„ë¡œí•„ì„ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤.

ê·¸ë¦¬ê³  ê·¸ í”„ë¡œí•„ì„ ê°€ì§€ê³ ìˆì„ ë³€ìˆ˜ë„ ë§Œë“¤ì–´ ì£¼ê³ , ê·¸ ë³€ìˆ˜ì— resultê°€ successì¼ê²½ìš° recordë¥¼ í•´ë‹¹ ë³€ìˆ˜ì— ë„£ì–´ì¤€ë‹¤.

ë¬´ìŠ¨ë§ì´ëƒë©´

```swift
private var existingProfileRecord: CKRecord?

func createProfile() {
    // ìƒëµ
    
    showLoadingView()
    CloudKitManager.shared.batchSave(records: [userRecord, profileRecord]) { result in
        DispatchQueue.main.async { [self] in
            hideLoadingView()
            switch result {            
            case .success(let records):
                for record in records where record.recordType == RecordType.profile { // new
                    existingProfileRecord = record
                }
                alertItem = AlertContext.createProfileSuccess
            case .failure(_):
                alertItem = AlertContext.createProfileFailure
                
                break
            }
        }
        
    }
}

func getProfile() {    
    // ìƒëµ
    
    showLoadingView()
    CloudKitManager.shared.fetchRecord(with: profileRecordID) { result in
        DispatchQueue.main.async { [self] in
            hideLoadingView()
            switch result {
            case .success(let record):
                existingProfileRecord = record // new
                let profile = DDGProfile(record: record)
                firstName = profile.firstName
                lastName = profile.lastName
                companyName = profile.companyName
                bio = profile.bio
                avatar = profile.createAvatarImage()
                
            case .failure(_):
                // show alert
                alertItem = AlertContext.unableToGetProfile
                break
            }
        }
    }
}
```

ì´ë ‡ê²Œ existingProfileRecord recordë¥¼ ë„£ì–´ì£¼ëŠ”ë°, createProfileë§Œ forë¥¼ ì“´ ì´ìœ ëŠ”, 
`CloudKitManager.shared.batchSave(records: [userRecord, profileRecord])` ì—¬ê¸°ì„œ recordsì— userRecord, profileRecord ë‘ê°œì˜ ê°’ì´ ë“¤ì–´ê°€ê¸° ë•Œë¬¸.

ìš°ë¦¬ëŠ” profileRecordë§Œ í•„ìš”í•˜ê¸°ì— í•´ë‹¹ë¶€ë¶„ë§Œ ë¹¼ì„œ ë„£ì–´ì£¼ëŠ” ê²ƒì´ë‹¤.

ì´ë ‡ê²Œ í–ˆìœ¼ë©´ updateProfile í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ ë³¸ë‹¤.
(ì´ë•Œ ì•„ê¹Œ ë§Œë“  save ê°€ ì‚¬ìš©ëœë‹¤.)

ê·¸ë¦¬ê³  AlertItemë„ ì¶”ê°€í•´ì£¼ì


```swift
func updateProfile() {
    guard isValidProfile() else {
        alertItem = AlertContext.invalidProfile
        return
    }
    
    guard let profileRecord = existingProfileRecord else {
        alertItem = AlertContext.unableToGetProfile
        return
    }
    
    profileRecord[DDGProfile.kFirstName] = firstName
    profileRecord[DDGProfile.kLastName] = lastName
    profileRecord[DDGProfile.kCompanyName] = companyName
    profileRecord[DDGProfile.kBio] = bio
    profileRecord[DDGProfile.kAvatar] = avatar.convertToCKAsset()
    
    showLoadingView()
    CloudKitManager.shared.save(record: profileRecord) { result in
        DispatchQueue.main.async { [self] in
            hideLoadingView()
            switch result {
            case .success(_):
                alertItem = AlertContext.updateProfileSuccess
            case .failure(_):
                alertItem = AlertContext.updateProfileFailure
            }
        }
    }
    
}

// AlertItem
static let updateProfileSuccess = AlertItem( // ìƒëµ 
)

static let updateProfileFailure = AlertItem( // ìƒëµ
)
```

## Enumì„ í†µí•œ create, update ë¶„ë¥˜

ì§€ê¸ˆ ViewModelì—ëŠ” ProfileRecordë¥¼ ì €ì¥í•˜ëŠ” ê´€ë ¨ í•¨ìˆ˜ëŠ” Create, Update 2ê°œê°€ ìˆë‹¤.

ì´ê±¸ Enumì„ í†µí•´ ê° ì¼€ì´ìŠ¤ì— ë§ê²Œ ë²„íŠ¼ ë° í•¨ìˆ˜ë¥¼ ë‹¤ë¥´ê²Œ ì‘ë™í•˜ë„ë¡ ë°”ê¿”ë³¸ë‹¤.

```swift
enum ProfileContext {
    case create, update
}
```

ìš°ì„  ì´ë ‡ê²Œ 2ê°€ì§€ ì¼€ì´ìŠ¤ì— ëŒ€í•´ ë§Œë“¤ì–´ ì¤€ë‹¤.

ê·¸ë¦¬ê³  didSetì„ ì‚¬ìš©í•˜ì—¬ existingProfileRecordì˜ ê°’ì´ ë³€í• ë•Œ profileContextê°€ updateë¡œ ë˜ë„ë¡ ë°”ê¿”ì¤€ë‹¤.

```swift
private var existingProfileRecord: CKRecord? {
        didSet { profileContext = .update }
    }
```

ì´í›„ ë²„íŠ¼ì„ ìˆ˜ì • í•´ì¤€ë‹¤.

ì´ë•Œ 3í•­ì—°ì‚°ìë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡°ê±´ì— ë§ê²Œ createëƒ updateëƒë¡œ í•´ì£¼ë©´ ëœë‹¤.

```swift
// ProfileView

Button {
    viewModel.profileContext == .create ? viewModel.createProfile() : viewModel.updateProfile()
} label: {
    DDGButton(title: viewModel.profileContext == .create ? "Create Profile" : "Update Profile")
}
```

ì´ì œ ì‹¤í–‰ì„ í•´ë³´ë©´

ì²˜ìŒì— ì•±ì„ ìƒˆë¡œ ì„¤ì¹˜í•˜ê³  í”„ë¡œí•„ì„ ë§Œë“¤ì–´ì•¼í•˜ëŠ” ì²«í™”ë©´

![Image](https://github.com/user-attachments/assets/0ee84dab-c5fd-42fe-9783-1d5ab7c9fc6f){: width="50%" height="50%"} 

í”„ë¡œí•„ì„ ì„¤ì •í•˜ê³  ì´í›„ì˜ í™”ë©´

![Image](https://github.com/user-attachments/assets/82f0a5e5-d65d-4aa0-a9ef-6aea4f2141dd){: width="50%" height="50%"} 

ì´ë ‡ê²Œ 2ê°œì˜ í™”ë©´ìœ¼ë¡œ ë²„íŠ¼ì´ ë‹¤ë¥´ê²Œ í‘œì‹œë˜ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.

## `didSet`ì„ ì‚¬ìš©í•œ ì´ìœ 

í”„ë¡œí•„ì„ ì²˜ìŒ ìƒì„±í•  ë•ŒëŠ” `existingProfileRecord`ê°€ `nil`ì´ë¯€ë¡œ  
`profileContext = .create` ìƒíƒœì´ë‹¤.  
ê·¸ëŸ¬ë‚˜ ì‚¬ìš©ìê°€ ê¸°ì¡´ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ë©´, `existingProfileRecord`ì— ê°’ì´ ì„¤ì •ë˜ë©´ì„œ  
ë²„íŠ¼ì˜ ìƒíƒœê°€ `"Create Profile"` â†’ `"Update Profile"`ë¡œ ë³€ê²½ë˜ì–´ì•¼ í•œë‹¤.

ì´ë¥¼ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ `didSet`ì„ ì‚¬ìš©í•˜ì—¬  
`existingProfileRecord` ê°’ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ `profileContext`ë¥¼ `.update`ë¡œ ì„¤ì •í•˜ë„ë¡ í–ˆë‹¤.

---

### **ì•±ì˜ íë¦„**
1. **ì•±ì´ ì‹¤í–‰ë˜ë©´** `AppTabView`ì—ì„œ `CloudKitManager.getUserRecord()`ë¥¼ í˜¸ì¶œ  
2. **ìœ ì €ê°€ ProfileViewë¡œ ì§„ì…í•˜ë©´** `ViewModel.getProfile()`ì´ ì‹¤í–‰ë¨  
3. `getProfile()` ë‚´ë¶€ì—ì„œ `userRecord`ë¥¼ ê°€ì ¸ì™€ `fetchRecord()`ë¥¼ í˜¸ì¶œí•˜ì—¬  
   - âœ… `existingRecord`ì— ê°’ì´ ìˆìœ¼ë©´ â†’ `profileContext = .update`  
   - âŒ `existingRecord`ê°€ ì—†ë‹¤ë©´ â†’ `profileContext = .create`  

---

### **`didSet`ì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ì–»ëŠ” ì´ì **
- âœ… **ê°’ì´ ë³€ê²½ë  ë•Œ ìë™ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸**  
  - `existingProfileRecord`ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ `profileContext`ë¥¼ `.update`ë¡œ ì„¤ì •  
  - **ë³„ë„ì˜ ì¶”ê°€ ë¡œì§ ì—†ì´ ë²„íŠ¼ ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥**  

- âœ… **UIì™€ ë°ì´í„° íë¦„ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°ë¨**  
  - í”„ë¡œí•„ì´ ì—†ì„ ë•Œë§Œ `"Create Profile"` ë²„íŠ¼ì´ í‘œì‹œë˜ë©°,  
    í”„ë¡œí•„ì´ ìˆìœ¼ë©´ `"Update Profile"` ë²„íŠ¼ì´ ìë™ìœ¼ë¡œ ì ìš©ë¨  

---

### ğŸ“ **ì •ë¦¬**
- `didSet`ì„ ì‚¬ìš©í•˜ë©´ `existingProfileRecord` ê°’ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤  
  `profileContext`ê°€ ìë™ìœ¼ë¡œ `.update`ë¡œ ì„¤ì •ë¨.  
- ì´ë¥¼ í†µí•´ **ViewModelê³¼ Viewê°€ ë™ê¸°í™”ë˜ë©°, ë²„íŠ¼ì˜ ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŒ.**  



---

Github: [Dub-Dub-Grub Repository](https://github.com/Haroldfromk/Dub-Dub-Grub){:target="_blank"}